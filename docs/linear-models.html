<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 8 線形モデル | データ解析マニュアル</title>
<meta name="author" content="水圏植物生態学研究室 (greg nishihara)">
<meta name="description" content="8.1 必要なパッケージ library(tidyverse) library(car) library(patchwork)  8.2 線形モデルとは？ 線形モデルの 線型 (linear) は直線 (straight line) と全く関係ないです。 線型モデルの線型は 線型結合 (linear combination) を意味しています。 \[ y = b_1 x_1 + b_2...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="Chapter 8 線形モデル | データ解析マニュアル">
<meta property="og:type" content="book">
<meta property="og:description" content="8.1 必要なパッケージ library(tidyverse) library(car) library(patchwork)  8.2 線形モデルとは？ 線形モデルの 線型 (linear) は直線 (straight line) と全く関係ないです。 線型モデルの線型は 線型結合 (linear combination) を意味しています。 \[ y = b_1 x_1 + b_2...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 8 線形モデル | データ解析マニュアル">
<meta name="twitter:description" content="8.1 必要なパッケージ library(tidyverse) library(car) library(patchwork)  8.2 線形モデルとは？ 線形モデルの 線型 (linear) は直線 (straight line) と全く関係ないです。 線型モデルの線型は 線型結合 (linear combination) を意味しています。 \[ y = b_1 x_1 + b_2...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">データ解析マニュアル</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">このマニュアルについて</a></li>
<li><a class="" href="data-input.html"><span class="header-section-number">1</span> データの読み込み</a></li>
<li><a class="" href="data-wrangling.html"><span class="header-section-number">2</span> データの処理</a></li>
<li><a class="" href="data-logger-input.html"><span class="header-section-number">3</span> ロガーからの読み込み</a></li>
<li><a class="" href="data-summary.html"><span class="header-section-number">4</span> データの集計</a></li>
<li><a class="" href="map-function.html"><span class="header-section-number">5</span> map 関数ってすごい</a></li>
<li><a class="" href="t-test.html"><span class="header-section-number">6</span> t 検定</a></li>
<li><a class="" href="anova.html"><span class="header-section-number">7</span> 分散分析</a></li>
<li><a class="active" href="linear-models.html"><span class="header-section-number">8</span> 線形モデル</a></li>
<li><a class="" href="gam.html"><span class="header-section-number">9</span> 一般化加法モデル</a></li>
<li><a class="" href="model-selection.html"><span class="header-section-number">10</span> モデル選択</a></li>
<li><a class="" href="non-linear-model01.html"><span class="header-section-number">11</span> 非線形モデル-I</a></li>
<li><a class="" href="ggplot.html"><span class="header-section-number">12</span> ggplot</a></li>
<li><a class="" href="maps.html"><span class="header-section-number">13</span> 地図の作り方</a></li>
<li><a class="" href="wind-fetch.html"><span class="header-section-number">14</span> 送風距離 (フェッチ, wind fetch )</a></li>
<li><a class="" href="redundancy-analysis.html"><span class="header-section-number">15</span> 冗長性分析 (RDA)</a></li>
<li><a class="" href="wavelet.html"><span class="header-section-number">16</span> Wavelet 解析</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/gnishihara/Lab-Manual">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="linear-models" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> 線形モデル<a class="anchor" aria-label="anchor" href="#linear-models"><i class="fas fa-link"></i></a>
</h1>
<div id="必要なパッケージ-7" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> 必要なパッケージ<a class="anchor" aria-label="anchor" href="#%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8-7"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-forge.r-project.org/projects/car/">car</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="線形モデルとは" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> 線形モデルとは？<a class="anchor" aria-label="anchor" href="#%E7%B7%9A%E5%BD%A2%E3%83%A2%E3%83%87%E3%83%AB%E3%81%A8%E3%81%AF"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>線形モデルの <strong>線型 (linear)</strong> は直線 (straight line) と全く関係ないです。</li>
<li>線型モデルの線型は <strong>線型結合 (linear combination)</strong> を意味しています。</li>
</ul>
<p><span class="math display">\[
y = b_1 x_1 + b_2 x_2 + b_3 x_3 + \cdots + b_n x_n
\]</span>
<span class="math inline">\(b_i\)</span> は係数，<span class="math inline">\(x_i\)</span> はベクトル（変数, 説明変数）です。<span class="math inline">\(y\)</span> が <span class="math inline">\(x_i\)</span> の線型結合です。</p>
</div>
<div id="線型モデルは直線じゃなくてもいい" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> 線型モデルは直線じゃなくてもいい<a class="anchor" aria-label="anchor" href="#%E7%B7%9A%E5%9E%8B%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AF%E7%9B%B4%E7%B7%9A%E3%81%98%E3%82%83%E3%81%AA%E3%81%8F%E3%81%A6%E3%82%82%E3%81%84%E3%81%84"><i class="fas fa-link"></i></a>
</h2>
<p><strong>線形モデル</strong></p>
<ul>
<li><span class="math inline">\(\mu = \beta_0 + \beta_1 x_1\)</span></li>
<li><span class="math inline">\(\mu = \beta_0 + \beta_1 x_1 + \beta_2 x_2^2\)</span></li>
<li><span class="math inline">\(\mu = \beta_0 + \beta_1\exp(x_1)\)</span></li>
</ul>
<p><strong>非線形モデル</strong></p>
<ul>
<li><span class="math inline">\(\mu = \frac{\beta_1 x_1}{\beta_2 + x_1}\)</span></li>
<li><span class="math inline">\(\mu = \beta_1 \left(1-\exp(\beta_2 x_1)\right) + \beta_3\)</span></li>
<li><span class="math inline">\(\mu = \beta_0 + \beta_1\exp(\beta_2 x_1)\)</span></li>
</ul>
<p>線形モデルは直線じゃなくてもいい。
ただし，変数 (<span class="math inline">\(x_i\)</span>) は線型結合であることが重要なポイントです。
では、検討しているモデルは線形モデルかどうかを確認したいなら、パラメータに対してモデルの偏微分方程式を求めてください。</p>
<p>たとえば、モデルパラメータ <span class="math inline">\((\beta_i)\)</span> に対して，<span class="math inline">\(\mu\)</span>を微分します。</p>
<p><span class="math display">\[
\mu = \beta_0 + \beta_1 x_1 + \beta_2 x_2^2
\]</span></p>
<p>パラメータの数ほど微分方程式があります。</p>
<p><span class="math display">\[
\frac{\partial \mu}{\partial \beta_0}  = 1 \qquad
\frac{\partial \mu}{\partial \beta_1}  = x_1 \qquad
\frac{\partial \mu}{\partial \beta_2}  = x_2
\]</span></p>
<p><span class="math inline">\(\beta_i\)</span> はどの微分方程式に残らないので，このモデルは線形モデルでしょう。</p>
<p>次のモデルは非線形モデルです。</p>
<p><span class="math display">\[
\mu = \frac{\beta_1 x_1}{\beta_2 + x_1}
\]</span></p>
<p>モデルパラメータは <span class="math inline">\(\beta_1\)</span>, <span class="math inline">\(\beta_2\)</span> ですね。
ではパラメータに対する偏微分方程式は次の通りです。</p>
<p><span class="math display">\[
\begin{aligned}
\frac{\partial \mu}{\partial \beta_1}  &amp;= \frac{x_1}{\beta_2 x_1} \\
\frac{\partial \mu}{\partial \beta_2}  &amp;= -\frac{x_1}{(\beta_2 x_2)^2}
\end{aligned}
\]</span></p>
<p>パラメータはお互いの方程式に残るので，このモデルは線形モデルではないですね。</p>
</div>
<div id="線形モデルの仮定" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> 線形モデルの仮定<a class="anchor" aria-label="anchor" href="#%E7%B7%9A%E5%BD%A2%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BB%AE%E5%AE%9A"><i class="fas fa-link"></i></a>
</h2>
<p>線形モデルを用いるときに守るべき仮定は分散分析と同じです。</p>
<ul>
<li>残差が正規分布に従うこと。</li>
<li>残差またはデータはお互いに独立し，同一分布から発生していること。</li>
</ul>
<p>モデルに対する注意する点</p>
<ul>
<li>説明変数もお互いに関係性（相関関係）が低いこと（関係ないほうがいい）。
<ul>
<li>関係性が高いとき，モデルパラメータの推定量の精度 (precision) と正確度 (accuracy) が落ちます。</li>
<li>この現象は多重共線性 (multicollinearity) とよびます。</li>
</ul>
</li>
<li>説明変数はお互いに関係がなければ，<strong>直交性 (orthogonal)</strong> のあるモデルとなり，変数の推定量はお互いとの相関性がないです。</li>
</ul>
<p>野外データは上の条件を満たすことは珍しいが、すべての条件を満たさなくても解析はできます。
ただし、結果の解釈と考察には気をつけましょう。</p>
</div>
<div id="一般線形モデルの例-general-linear-model" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> 一般線形モデルの例 (General Linear Model)<a class="anchor" aria-label="anchor" href="#%E4%B8%80%E8%88%AC%E7%B7%9A%E5%BD%A2%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BE%8B-general-linear-model"><i class="fas fa-link"></i></a>
</h2>
<p>解析例にはアヤメのデータをつかっています。
ちなみに、一般線形モデルは一般化線形モデル (Generalized Linear Model, GLM) の特例です。</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span> <span class="op">=</span> <span class="va">iris</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">iris</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 150 × 5</span>
<span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span>
<span class="co">#&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span>
<span class="co">#&gt; 1          5.1         3.5          1.4         0.2 setosa </span>
<span class="co">#&gt; 2          4.9         3            1.4         0.2 setosa </span>
<span class="co">#&gt; 3          4.7         3.2          1.3         0.2 setosa </span>
<span class="co">#&gt; # … with 147 more rows</span></code></pre></div>
<p>検討する線型モデルは次の通りです。</p>
<p><span class="math display">\[
E(\text{Petal Length}) = b_0 + b_1\text{Petal Width} + b_2\text{Sepal Length} + b_3\text{Sepal Width}
\]</span></p>
<p><span class="math inline">\(E(\text{Petal Length})\)</span> は花びらの長さの<strong>期待値 (expected value)</strong> といいます。</p>
<p>線形モデルなので，<code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> 関数で解析できます。
さらに、分散分析表も存在します。</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Petal.Length</span> <span class="op">~</span> <span class="va">Petal.Width</span> <span class="op">+</span> <span class="va">Sepal.Length</span> <span class="op">+</span> <span class="va">Sepal.Width</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span></code></pre></div>
<p>分散分析表は <code><a href="https://rdrr.io/r/stats/summary.aov.html">summary.aov()</a></code> でだします。</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/summary.aov.html">summary.aov</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt;               Df Sum Sq Mean Sq F value Pr(&gt;F)</span>
<span class="co">#&gt; Petal.Width    1  430.5   430.5 4231.49 &lt;2e-16</span>
<span class="co">#&gt; Sepal.Length   1    9.9     9.9   97.74 &lt;2e-16</span>
<span class="co">#&gt; Sepal.Width    1    9.0     9.0   88.95 &lt;2e-16</span>
<span class="co">#&gt; Residuals    146   14.9     0.1</span></code></pre></div>
<p>モデルに入れた全ての説明変数のP値は <span class="math inline">\(&lt; 0.0001\)</span> ですね。</p>
<p>では、線形モデルの係数表を出してみましょう。</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = Petal.Length ~ Petal.Width + Sepal.Length + Sepal.Width, </span>
<span class="co">#&gt;     data = iris)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;      Min       1Q   Median       3Q      Max </span>
<span class="co">#&gt; -0.99333 -0.17656 -0.01004  0.18558  1.06909 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;              Estimate Std. Error t value Pr(&gt;|t|)</span>
<span class="co">#&gt; (Intercept)  -0.26271    0.29741  -0.883    0.379</span>
<span class="co">#&gt; Petal.Width   1.44679    0.06761  21.399   &lt;2e-16</span>
<span class="co">#&gt; Sepal.Length  0.72914    0.05832  12.502   &lt;2e-16</span>
<span class="co">#&gt; Sepal.Width  -0.64601    0.06850  -9.431   &lt;2e-16</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 0.319 on 146 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.968,  Adjusted R-squared:  0.9674 </span>
<span class="co">#&gt; F-statistic:  1473 on 3 and 146 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p><code>Petal.Length</code> に対して，<code>Petal.Width</code> と <code>Sepal.Length</code> は正の効果があり，<code>Sepal.Width</code> とは負の効果がありました。
つまり， <code>Petal.Width</code> と <code>Sepal.Length</code> が上昇すると， <code>Petal.Length</code> も上昇します。</p>
<p>分散分析表の場合は、それぞれの変数に対するF値がでたが、係数表の場合は t値 がでました。
当然それぞれの値も異なった。</p>
<p>何が違うのか？</p>
<p>まず、分散分析の平方和って、さまざま求め方がるあることに気づきましょう。</p>
<ul>
<li>Type-I Sum-of-squares
<ul>
<li>SS(A), SS(B|A), SS(AB|B, A)</li>
</ul>
</li>
<li>Type-II Sum-of-squares
<ul>
<li>SS(A|B), SS(B|A)</li>
</ul>
</li>
<li>Type-III Sum-of-squares
<ul>
<li>SS(A|B), SS(B|A), SS(AB|B,A)</li>
</ul>
</li>
</ul>
<p>他にもありますが、この 3 つが一般的にです。</p>
<p><strong>Type-I</strong> の場合、結果は変数の順序に依存します。
<strong>Type-II</strong> の場合、順序に依存しないが、相互作用はない。
<strong>Type-III</strong> の場合、順序に依存しないが、相互作用の影響も計算されます。</p>
<p><strong>Type-I</strong> はRのデフォルトなので、<strong>Type-II</strong> または <strong>Type-II</strong> を使いたいなら、
<code>car</code> パッケージの <code><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova()</a></code> 関数が必要です。</p>
<p>といくおとで、説明変数の順序をかえるた、次のように異なる結果が返ってきます。</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1a</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Petal.Length</span> <span class="op">~</span> <span class="va">Petal.Width</span> <span class="op">+</span> <span class="va">Sepal.Length</span> <span class="op">+</span> <span class="va">Sepal.Width</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span>
<span class="va">m1b</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Petal.Length</span> <span class="op">~</span> <span class="va">Petal.Width</span> <span class="op">+</span> <span class="va">Sepal.Width</span> <span class="op">+</span> <span class="va">Sepal.Length</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span>
<span class="va">m1c</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Petal.Length</span> <span class="op">~</span> <span class="va">Sepal.Width</span> <span class="op">+</span> <span class="va">Petal.Width</span> <span class="op">+</span> <span class="va">Sepal.Length</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span>
<span class="va">m1a</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/stats/summary.aov.html">summary.aov</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;               Df Sum Sq Mean Sq F value Pr(&gt;F)    </span>
<span class="co">#&gt; Petal.Width    1  430.5   430.5 4231.49 &lt;2e-16 ***</span>
<span class="co">#&gt; Sepal.Length   1    9.9     9.9   97.74 &lt;2e-16 ***</span>
<span class="co">#&gt; Sepal.Width    1    9.0     9.0   88.95 &lt;2e-16 ***</span>
<span class="co">#&gt; Residuals    146   14.9     0.1                   </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  </span>
<span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="va">m1b</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/stats/summary.aov.html">summary.aov</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;               Df Sum Sq Mean Sq F value   Pr(&gt;F)    </span>
<span class="co">#&gt; Petal.Width    1  430.5   430.5 4231.49  &lt; 2e-16 ***</span>
<span class="co">#&gt; Sepal.Width    1    3.1     3.1   30.37 1.57e-07 ***</span>
<span class="co">#&gt; Sepal.Length   1   15.9    15.9  156.31  &lt; 2e-16 ***</span>
<span class="co">#&gt; Residuals    146   14.9     0.1                     </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  </span>
<span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="va">m1c</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/stats/summary.aov.html">summary.aov</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;               Df Sum Sq Mean Sq F value Pr(&gt;F)    </span>
<span class="co">#&gt; Sepal.Width    1   85.2    85.2   837.8 &lt;2e-16 ***</span>
<span class="co">#&gt; Petal.Width    1  348.3   348.3  3424.1 &lt;2e-16 ***</span>
<span class="co">#&gt; Sepal.Length   1   15.9    15.9   156.3 &lt;2e-16 ***</span>
<span class="co">#&gt; Residuals    146   14.9     0.1                   </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  </span>
<span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></code></pre></div>
<p>このとき、<code>car</code> パッケージの <code><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova()</a></code> 関数を使って平方和の求め方を指定します。
相互作用なしのモデルなので、Type-II を指定しました。
相互作用も調べたいなら、<code>type="III"</code> を渡してください。</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1a</span> |&gt; <span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"II"</span><span class="op">)</span>
<span class="co">#&gt; Anova Table (Type II tests)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Response: Petal.Length</span>
<span class="co">#&gt;              Sum Sq  Df F value    Pr(&gt;F)    </span>
<span class="co">#&gt; Petal.Width  46.584   1 457.905 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Sepal.Length 15.902   1 156.312 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Sepal.Width   9.049   1  88.947 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Residuals    14.853 146                      </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  </span>
<span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="va">m1b</span> |&gt; <span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"II"</span><span class="op">)</span>
<span class="co">#&gt; Anova Table (Type II tests)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Response: Petal.Length</span>
<span class="co">#&gt;              Sum Sq  Df F value    Pr(&gt;F)    </span>
<span class="co">#&gt; Petal.Width  46.584   1 457.905 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Sepal.Width   9.049   1  88.947 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Sepal.Length 15.902   1 156.312 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Residuals    14.853 146                      </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  </span>
<span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="va">m1c</span> |&gt; <span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"II"</span><span class="op">)</span>
<span class="co">#&gt; Anova Table (Type II tests)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Response: Petal.Length</span>
<span class="co">#&gt;              Sum Sq  Df F value    Pr(&gt;F)    </span>
<span class="co">#&gt; Sepal.Width   9.049   1  88.947 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Petal.Width  46.584   1 457.905 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Sepal.Length 15.902   1 156.312 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; Residuals    14.853 146                      </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  </span>
<span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></code></pre></div>
<p>係数表は t値の結果は Wald’s test と呼びます。</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = Petal.Length ~ Petal.Width + Sepal.Length + Sepal.Width, </span>
<span class="co">#&gt;     data = iris)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;      Min       1Q   Median       3Q      Max </span>
<span class="co">#&gt; -0.99333 -0.17656 -0.01004  0.18558  1.06909 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;              Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)  -0.26271    0.29741  -0.883    0.379    </span>
<span class="co">#&gt; Petal.Width   1.44679    0.06761  21.399   &lt;2e-16 ***</span>
<span class="co">#&gt; Sepal.Length  0.72914    0.05832  12.502   &lt;2e-16 ***</span>
<span class="co">#&gt; Sepal.Width  -0.64601    0.06850  -9.431   &lt;2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  </span>
<span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 0.319 on 146 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.968,  Adjusted R-squared:  0.9674 </span>
<span class="co">#&gt; F-statistic:  1473 on 3 and 146 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p>このとき、<span class="math inline">\(\beta = 0\)</span> の帰無仮説を検証しています。
つまり、係数の値は 0 か 0 じゃないかですね。</p>
<p>Wald’s test と F-test のこちらもモデルの解析に使えます。
ところが、一般的には、モデル選択に F-test を使いますが、
係数が 0 か 0 じゃないかの検証には Wald’s test を使います。
ちなみに、このモデルの場合、<span class="math inline">\((t_\nu)^2 = F_{(1,\nu)}\)</span> なので、
係数表のt値の2乗は Type-II 分散分析のF値と同じです。</p>
</div>
<div id="モデル診断" class="section level2" number="8.6">
<h2>
<span class="header-section-number">8.6</span> モデル診断<a class="anchor" aria-label="anchor" href="#%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%BA%E6%96%AD"><i class="fas fa-link"></i></a>
</h2>
<p>モデルを当てはめたあと、最も重要な解析はモデル残渣の確認です。
モデル残渣に異常があると、モデルとデータの相性が悪いです。
モデルとデータが合わない場合、求めた係数を信用できません。</p>
<p>一般線形モデルのとき、標準化残渣 (standardized residuals) をもとめて、モデルの良さを目で確認します。
つまり、標準化残渣を様々形の図を作ります。</p>
<p>まず、残渣を持てめて、図に使うデータを準備します。</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">firis</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">firis</span>
<span class="co">#&gt; # A tibble: 150 × 10</span>
<span class="co">#&gt;    Petal.Length Petal.Width Sepal.Length Sepal.Width   .hat</span>
<span class="co">#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt;  1          1.4         0.2          5.1         3.5 0.0205</span>
<span class="co">#&gt;  2          1.4         0.2          4.9         3   0.0212</span>
<span class="co">#&gt;  3          1.3         0.2          4.7         3.2 0.0201</span>
<span class="co">#&gt;  4          1.5         0.2          4.6         3.1 0.0221</span>
<span class="co">#&gt;  5          1.4         0.2          5           3.6 0.0230</span>
<span class="co">#&gt;  6          1.7         0.4          5.4         3.9 0.0327</span>
<span class="co">#&gt;  7          1.4         0.3          4.6         3.4 0.0255</span>
<span class="co">#&gt;  8          1.5         0.2          5           3.4 0.0189</span>
<span class="co">#&gt;  9          1.4         0.2          4.4         2.9 0.0293</span>
<span class="co">#&gt; 10          1.5         0.1          4.9         3.1 0.0225</span>
<span class="co">#&gt; # … with 140 more rows, and 5 more variables: .sigma &lt;dbl&gt;,</span>
<span class="co">#&gt; #   .cooksd &lt;dbl&gt;, .fitted &lt;dbl&gt;, .resid &lt;dbl&gt;,</span>
<span class="co">#&gt; #   .stdresid &lt;dbl&gt;</span></code></pre></div>
<div id="残渣の正規性" class="section level3" number="8.6.1">
<h3>
<span class="header-section-number">8.6.1</span> 残渣の正規性<a class="anchor" aria-label="anchor" href="#%E6%AE%8B%E6%B8%A3%E3%81%AE%E6%AD%A3%E8%A6%8F%E6%80%A7"><i class="fas fa-link"></i></a>
</h3>
<p>まずは残渣は正規分布に従うかを評価します。
正規性はヒストグラムとQQプロットでします。
残渣が正規分布に従うなら、ヒストグラムは正規分布に似ていて、
QQプロットでは残渣を示す点が赤色の直線上に並びます。</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">firis</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.stdresid</span>, y <span class="op">=</span> <span class="va">..density..</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html">stat_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">dnorm</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Standardized residual"</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> </code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-10"></span>
<img src="24-analysis-glm_files/figure-html/unnamed-chunk-10-1.png" alt="残渣のヒストグラムと正規分布。" width="90%"><p class="caption">
Figure 8.1: 残渣のヒストグラムと正規分布。
</p>
</div>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">firis</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html">geom_qq</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Theoretical Quantile"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span> </code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-11"></span>
<img src="24-analysis-glm_files/figure-html/unnamed-chunk-11-1.png" alt="QQプロット" width="90%"><p class="caption">
Figure 8.2: QQプロット
</p>
</div>
<p>どちらの図を確認しても、標準化残渣は正規分布に従っているように見えます。</p>
</div>
<div id="残渣のばらつき" class="section level3" number="8.6.2">
<h3>
<span class="header-section-number">8.6.2</span> 残渣のばらつき<a class="anchor" aria-label="anchor" href="#%E6%AE%8B%E6%B8%A3%E3%81%AE%E3%81%B0%E3%82%89%E3%81%A4%E3%81%8D"><i class="fas fa-link"></i></a>
</h3>
<p>正規性に問題がなければ、次は標準化残渣のばらつきを確認したいです。
すべての変数に対して残渣の図をつくります。
また、求めた期待値に対しても残渣を確認します。
残渣になんかしらのパタンがあると、問題です。</p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">firis</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"Petal|Sepal"</span><span class="op">)</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"Petal|Sepal"</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-12"></span>
<img src="24-analysis-glm_files/figure-html/unnamed-chunk-12-1.png" alt="標準化残渣と応答変数、それぞれの説明変数との関係。" width="90%"><p class="caption">
Figure 8.3: 標準化残渣と応答変数、それぞれの説明変数との関係。
</p>
</div>
<p>残渣は 0 をまたいで均等にばらついていることが確認できました。
さらに、ばらつきに明確なパタンがないので、この点についてモデルには問題なさそうです。
次は残渣と期待値の関係を確認します。</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">firis</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.fitted</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> </code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-13"></span>
<img src="24-analysis-glm_files/figure-html/unnamed-chunk-13-1.png" alt="標準化残渣と期待値の関係。" width="90%"><p class="caption">
Figure 8.4: 標準化残渣と期待値の関係。
</p>
</div>
<p>期待値と標準化残渣の関係を確認すると、特に問題はないですね。
場合によって、標準化残渣の絶対値の平方根で確認しやすい場合もあります。
この解析の場合は不必要ですが、コードと結果は次の通りです。</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">firis</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.fitted</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-14"></span>
<img src="24-analysis-glm_files/figure-html/unnamed-chunk-14-1.png" alt="標準化残渣の平方根と期待値の関係。" width="90%"><p class="caption">
Figure 8.5: 標準化残渣の平方根と期待値の関係。
</p>
</div>
<p>最後に、クックの距離を確認します。クックの距離 (Cook’s distance) はモデルの当てはめに強く影響する値を検出してくれます。
データ点のクックの距離が <span class="math inline">\(P(F_{(n, n-p)}=0.5)\)</span> を超えた場合、ちょっと怪しいかもしれないです。</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dof</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"df"</span><span class="op">)</span>
<span class="va">thold</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html">qf</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">firis</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>above <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.cooksd</span> <span class="op">&gt;</span> <span class="va">thold</span>, <span class="cn">T</span>, <span class="cn">F</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">.cooksd</span>, color <span class="op">=</span> <span class="va">above</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">thold</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-15-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>診断図から問題ないと判断できたら、説明変数の多重鏡線性を確認しましょう。
まず，説明変数がお互いに相関があるかを確認します。</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Species</span>, <span class="op">-</span> <span class="va">Petal.Length</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;              Sepal.Length Sepal.Width Petal.Width</span>
<span class="co">#&gt; Sepal.Length    1.0000000  -0.1175698   0.8179411</span>
<span class="co">#&gt; Sepal.Width    -0.1175698   1.0000000  -0.3661259</span>
<span class="co">#&gt; Petal.Width     0.8179411  -0.3661259   1.0000000</span></code></pre></div>
<p><code>Petal.Width</code> と <code>Sepal.Length</code> の相関は高いですが，他は 0 に近いので相関関係は低いです。
多重共線性をしっかりと確認したければ，分散拡大係数 (Variance Inflation Factor; VIF) をもとめます。</p>
<p>VIF は決定係数 <span class="math inline">\((R_i^2)\)</span> をつかって計算するので，方程式は次の通りです。</p>
<p><span class="math display">\[
\text{VIF} = \frac{1}{1-R_i^2}
\]</span></p>
<p>VIF を計算するには，説明変数 <span class="math inline">\(x_i\)</span> を他の説明変数 <span class="math inline">\(x_{j \neq i}\)</span> との線形モデル組み立てて，決定係数を求める必要があります。</p>
<p>つまり，先ほどの相関係数の結果をつかうと，</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Petal.Width</span> <span class="op">~</span> <span class="va">Sepal.Length</span> <span class="op">+</span> <span class="va">Sepal.Width</span>, 
        data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"r.squared"</span><span class="op">)</span>
<span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">Petal.Width</span> <span class="op">+</span> <span class="va">Sepal.Width</span>, 
        data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"r.squared"</span><span class="op">)</span>
<span class="va">x3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Sepal.Width</span> <span class="op">~</span> <span class="va">Sepal.Length</span> <span class="op">+</span> <span class="va">Petal.Width</span>, 
        data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"r.squared"</span><span class="op">)</span>
<span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x1</span>,<span class="va">x2</span>,<span class="va">x3</span><span class="op">)</span><span class="op">)</span> <span class="co"># VIF</span>
<span class="co">#&gt; [1] 3.889961 3.415733 1.305515</span></code></pre></div>
<p><code>car</code> パッケージの <code><a href="https://rdrr.io/pkg/car/man/vif.html">vif()</a></code> 関数の方が便利です。</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/vif.html">vif</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>
<span class="co">#&gt;  Petal.Width Sepal.Length  Sepal.Width </span>
<span class="co">#&gt;     3.889961     3.415733     1.305515</span></code></pre></div>
<p><span class="math inline">\(VIF(\beta_i) &gt; 10\)</span> であれば，多重共線性の問題は大きいと考えられます。
このときの決定係数は <span class="math inline">\(1-1/10 = 0.90\)</span> です。</p>
</div>
</div>
<div id="ガラパゴス諸島における種数の解析" class="section level2" number="8.7">
<h2>
<span class="header-section-number">8.7</span> ガラパゴス諸島における種数の解析<a class="anchor" aria-label="anchor" href="#%E3%82%AC%E3%83%A9%E3%83%91%E3%82%B4%E3%82%B9%E8%AB%B8%E5%B3%B6%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E7%A8%AE%E6%95%B0%E3%81%AE%E8%A7%A3%E6%9E%90"><i class="fas fa-link"></i></a>
</h2>
<p><code>iris</code> データの解析に大きな問題がなかったので、あまり参考にならなかったので、
ガラパゴス諸島のデータを解析してみましょう。</p>
<p><code>faraway</code> パッケージの <code>gala</code> を解析します。
<code>gala</code> にはガラパゴス諸島の生態系に対しての 7 つの変数があります。<code>Species</code> は植物の種数，<code>Endemics</code> は植物の固有種，
<code>Area</code> は島の平面積 (m<sup>2</sup>)，<code>Elevation</code> は島の最も高い場所 (m)，<code>Nearest</code> は最も近い島からの距離 (km)，<code>Scruz</code> はサンタクルス島からの距離 (km)，<code>Adjacent</code> は最も近い島の面積 (m<sup>2</sup>)です。</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">gala</span>, package <span class="op">=</span> <span class="st">"faraway"</span><span class="op">)</span>
<span class="va">gala</span> <span class="op">=</span> <span class="va">gala</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># tibble に変換</span>
<span class="va">gala</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="co"># 最初の 3 行を表示</span>
<span class="co">#&gt; # A tibble: 30 × 7</span>
<span class="co">#&gt;   Species Endemics  Area Elevation Nearest Scruz Adjacent</span>
<span class="co">#&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1      58       23 25.1        346     0.6   0.6     1.84</span>
<span class="co">#&gt; 2      31       21  1.24       109     0.6  26.3   572.  </span>
<span class="co">#&gt; 3       3        3  0.21       114     2.8  58.7     0.78</span>
<span class="co">#&gt; # … with 27 more rows</span></code></pre></div>
<p>解析する前に、データの可視化をします。</p>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-20-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>説明変数 (explanatory variable)、または予測子 (Predictor) に対する種数の変動は予測子によって変わることがわかります。</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gala_out</span> <span class="op">=</span> <span class="va">gala</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Endemics</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Predictor</span>, <span class="op">-</span><span class="va">Species</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">gala_out</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Predictor</span>, y<span class="op">=</span><span class="va">Species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="st">"Variable"</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span></code></pre></div>
<p>では、モデルと帰無仮設を決めます。</p>
<p>「種数の増減は予測子に依存する」を作業仮説にしたとき，モデルは次のようになります。</p>
<p><span class="math display">\[
E(\text{Species}) = b_0 + b_1\text{Area}+b_2\text{Elevation}+b_3\text{Nearest}+b_4\text{Scruz}+b_5\text{Adjacent}
\]</span></p>
<p>ネイマン＝ピアソン (Neyman-Pearson) の枠組みの中で解析するなら，帰無仮設と対立仮設を建てなければなりません。</p>
<ul>
<li>帰無仮設： <span class="math inline">\(b_0 = b_1 = b_2 = b_3 = b_4 = b_5\)</span>
</li>
<li>対立仮説： <span class="math inline">\(b_0 \neq b_1 \neq b_2 \neq b_3 \neq b_4 \neq b_5\)</span>
</li>
</ul>
<p>解析は次の通りです。
この度、帰無仮説のモデルもわさわさくみました。</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">H0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">gala</span><span class="op">)</span>  <span class="co"># これが帰無仮設のモデルです。</span>
<span class="va">HF</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">Area</span> <span class="op">+</span> <span class="va">Elevation</span> <span class="op">+</span> <span class="va">Nearest</span> <span class="op">+</span> <span class="va">Scruz</span> <span class="op">+</span> <span class="va">Adjacent</span>, data <span class="op">=</span> <span class="va">gala</span><span class="op">)</span> <span class="co"># これが対立仮説のモデルです。</span></code></pre></div>
<p>相互作用を入れていないが、Type-III SS を求めます。</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># anova(H0, HF) # Type-I SS</span>
<span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova</a></span><span class="op">(</span><span class="va">H0</span>, <span class="va">HF</span>, type <span class="op">=</span> <span class="st">"III"</span><span class="op">)</span>   <span class="co"># Type=III SS</span>
<span class="co">#&gt; Anova Table (Type III tests)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Response: Species</span>
<span class="co">#&gt;             Sum Sq Df F value    Pr(&gt;F)    </span>
<span class="co">#&gt; (Intercept) 217942  1  58.618 6.805e-08 ***</span>
<span class="co">#&gt; Residuals    89231 24                      </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  </span>
<span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></code></pre></div>
<p><strong>P値は &lt; 0.0001 なので，0.05 より小さいです。帰無仮設は棄却できます。</strong>
帰無仮設を棄却したら，採択するモデル（モデルは採択できるが，仮説は採択できません）の
診断図を作図して，残差のばらつきや正規性などを確認します。</p>
<p>では、HF の診断図を確認しましょう。</p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fgala</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">HF</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fgala</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.stdresid</span>, y <span class="op">=</span> <span class="va">..density..</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html">stat_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">dnorm</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Standardized residual"</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> 
<span class="va">p2</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fgala</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html">geom_qq</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Theoretical Quantile"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span> 
<span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-24-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>データ数は少ないが，残差は 0 を中心にしていて左右対称です。
殆どの残差はQQプロットの直線に沿っています。
よって，残差の正規性に大きな問題はなさそうです。</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Species</span>, <span class="va">Area</span>, <span class="va">Elevation</span>, <span class="va">Nearest</span>, <span class="va">Scruz</span>, <span class="va">Adjacent</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-25-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>予測子に対する残差の分布を確認すると，均等に分布していないように見えます。
例えば <strong>Residual vs. Nearest</strong> の場合，波状を描いているように見えます。</p>
</div>
<div id="モデルの診断図期待値に対する残差のばらつき" class="section level2" number="8.8">
<h2>
<span class="header-section-number">8.8</span> モデルの診断図：期待値に対する残差のばらつき<a class="anchor" aria-label="anchor" href="#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E8%A8%BA%E6%96%AD%E5%9B%B3%E6%9C%9F%E5%BE%85%E5%80%A4%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E6%AE%8B%E5%B7%AE%E3%81%AE%E3%81%B0%E3%82%89%E3%81%A4%E3%81%8D"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p1</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.fitted</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> 
<span class="va">p2</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.fitted</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> 
<span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-26-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>残差のばらつきは期待値と関係性が有るように見えます (Residual vs. Fitted Values Plot)。
Scale–Location Plot では，その関係が明確です。</p>
<p>次は異常値を探してみましょう。</p>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dof</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">HF</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"df"</span><span class="op">)</span>
<span class="va">thold</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html">qf</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>above <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.cooksd</span> <span class="op">&gt;</span> <span class="va">thold</span>, <span class="cn">T</span>, <span class="cn">F</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">.cooksd</span>, color <span class="op">=</span> <span class="va">above</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">thold</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-27-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>クックの距離が <span class="math inline">\(P(F_{(p, n-p)}=0.5)\)</span> を超えれば，影響力の高い点だと考えられます。
このとき，16番目のデータが明らかに超えています。</p>
<p><span class="math inline">\(P(F_{(p, n-p)}=0.5)\)</span>は自由度 <span class="math inline">\(p\)</span> (パラメータの数) と <span class="math inline">\(n-p\)</span> (データ数からパラメータ数の差) のときのF値の中央値です。</p>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html">cooks.distance</a></span><span class="op">(</span><span class="va">HF</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">thold</span><span class="op">)</span>
<span class="co">#&gt; 16 </span>
<span class="co">#&gt; 16</span></code></pre></div>
<p>いろいろと問題があったので、モデルの改良は必要ですね。
ところが、モデルを改良するときの問題点を意識してください。</p>
<p><strong>帰無仮設は棄却できたが，診断図を確認すると多数の問題点がありました。</strong>
このようなとき，モデルを改良する必要があります。
ただし，ネイマン=ピアソンの帰無仮設検定法のとき，<strong>検討するモデルが増えれば増えるほど第１種の誤りを起こす確率も上がります。</strong></p>
<p>5 つの予測子（変数）があるので，交互作用ありの一次式のモデルの場合，パラメータの数は32 です。
検証できるパラメータ数はデータ数に制限されるので，
パラメータ数とデータ数が等しいときのモデルは<a href="https://stats.stackexchange.com/questions/283/what-is-a-saturated-model">飽和モデル</a>とよびます。
ちなみに，32 パラメータのときの第 1 種の誤りを起こす確率は 0.8063 です。
飽和モデルのとき，分散を推定することができないので，飽和モデルは理論上のモデルです。</p>
</div>
<div id="モデル構築の考え方" class="section level2" number="8.9">
<h2>
<span class="header-section-number">8.9</span> モデル構築の考え方<a class="anchor" aria-label="anchor" href="#%E3%83%A2%E3%83%87%E3%83%AB%E6%A7%8B%E7%AF%89%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9"><i class="fas fa-link"></i></a>
</h2>
<p>モデルを設計するときに最も大事なことは：</p>
<ul>
<li>統計解析の仮定を守る</li>
<li>科学的・統計学的にありえる</li>
<li>説明しやすい</li>
<li>シンプル・単純である</li>
</ul>
<p>モデルの改良点：</p>
<ul>
<li>応答変数を変換する</li>
<li>説明変数を変換する</li>
<li>誤差項の分布を変える</li>
<li>モデルパラメータを増やす（二次関数・三次関数・交互作用など）</li>
</ul>
<div id="応答変数の変換" class="section level3" number="8.9.1">
<h3>
<span class="header-section-number">8.9.1</span> 応答変数の変換<a class="anchor" aria-label="anchor" href="#%E5%BF%9C%E7%AD%94%E5%A4%89%E6%95%B0%E3%81%AE%E5%A4%89%E6%8F%9B"><i class="fas fa-link"></i></a>
</h3>
<p>残差に問題があるとき，応答変数を変換することが一般的に行われています。
応答変数の変換は，残差を正規分布に従わせるためにします。</p>
<p>たとえば個体数はつねに <span class="math inline">\(y\ge 0\)</span> です。負の個体数は存在しません。
このとき，正規分布を仮定したら，0 近辺の値の 95% 信頼区間は負の値をとることもあります。
実データとの整合性がとれなくなります。
または，0 から 1 の値しか取れないデータのときでも正規性に問題がでます。</p>
<p>応答変数が個体数のような正の整数のとき，ログ変換することが多いです。<code>log(x)</code>
または，0 から 1 の比率の様なデータのとき，アークサイン変換をします。 <code>asin(x)</code></p>
</div>
</div>
<div id="応答変数変換した解析" class="section level2" number="8.10">
<h2>
<span class="header-section-number">8.10</span> 応答変数変換した解析<a class="anchor" aria-label="anchor" href="#%E5%BF%9C%E7%AD%94%E5%A4%89%E6%95%B0%E5%A4%89%E6%8F%9B%E3%81%97%E3%81%9F%E8%A7%A3%E6%9E%90"><i class="fas fa-link"></i></a>
</h2>
<p>応答変数をログ変換した解析と変換していない解析の結果はつぎの通りです。</p>
<p><strong>ログ変換後の分散分析表</strong></p>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gala</span> <span class="op">=</span> <span class="va">gala</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>logSpecies <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Species</span><span class="op">)</span><span class="op">)</span>
<span class="va">logHF</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">logSpecies</span><span class="op">~</span> <span class="va">Area</span> <span class="op">+</span> <span class="va">Elevation</span> <span class="op">+</span> <span class="va">Nearest</span> <span class="op">+</span> <span class="va">Scruz</span> <span class="op">+</span> <span class="va">Adjacent</span>, data <span class="op">=</span> <span class="va">gala</span><span class="op">)</span>
<span class="va">logHF</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"III"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; Anova Table (Type III tests)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Response: logSpecies</span>
<span class="co">#&gt;             Sum Sq Df F value    Pr(&gt;F)</span>
<span class="co">#&gt; (Intercept) 53.956  1 48.7039 3.238e-07</span>
<span class="co">#&gt; Area         3.998  1  3.6088   0.06955</span>
<span class="co">#&gt; Elevation   26.168  1 23.6211 5.927e-05</span>
<span class="co">#&gt; Nearest      0.918  1  0.8289   0.37164</span>
<span class="co">#&gt; Scruz        1.217  1  1.0984   0.30505</span>
<span class="co">#&gt; Adjacent     7.597  1  6.8575   0.01505</span>
<span class="co">#&gt; Residuals   26.588 24</span></code></pre></div>
<p><strong>変換なしの分散分析表</strong></p>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">HF</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"III"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; Anova Table (Type III tests)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Response: Species</span>
<span class="co">#&gt;             Sum Sq Df F value    Pr(&gt;F)</span>
<span class="co">#&gt; (Intercept)    506  1  0.1362 0.7153508</span>
<span class="co">#&gt; Area          4238  1  1.1398 0.2963180</span>
<span class="co">#&gt; Elevation   131767  1 35.4404 3.823e-06</span>
<span class="co">#&gt; Nearest          0  1  0.0001 0.9931506</span>
<span class="co">#&gt; Scruz         4636  1  1.2469 0.2752082</span>
<span class="co">#&gt; Adjacent     66406  1 17.8609 0.0002971</span>
<span class="co">#&gt; Residuals    89231 24</span></code></pre></div>
<p>変数（パラメータ）に対するP値はが変わりました。
変換なしの解析に比べて，ログ変換後の<code>Elevation</code> と <code>Nearest</code> のP値は下がりましたが，その他のP値は上がりました。</p>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fgala</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">logHF</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fgala</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.stdresid</span>, y <span class="op">=</span> <span class="va">..density..</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html">stat_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">dnorm</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Standardized residual"</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> 
<span class="va">p2</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fgala</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html">geom_qq</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Theoretical Quantile"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span> 
<span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-32-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>ログ変換なしの結果よりちょっと良くなったと思います。</p>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">logSpecies</span>, <span class="va">Area</span>, <span class="va">Elevation</span>, <span class="va">Nearest</span>, <span class="va">Scruz</span>, <span class="va">Adjacent</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-33-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>説明変数が上昇すると残差のばらつきが減少する傾向があるので，残差のばらつきに問題があります。</p>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p1</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.fitted</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> 
<span class="va">p2</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.fitted</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> 
<span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-34-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>期待値に対しても，残差のばらつきの均一性が問題です。さらに Scale - Location Plot には明らか傾向があります。</p>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dof</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">logHF</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"df"</span><span class="op">)</span>
<span class="va">thold</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html">qf</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>above <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.cooksd</span> <span class="op">&gt;</span> <span class="va">thold</span>, <span class="cn">T</span>, <span class="cn">F</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">.cooksd</span>, color <span class="op">=</span> <span class="va">above</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">thold</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-35-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html">cooks.distance</a></span><span class="op">(</span><span class="va">logHF</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">thold</span><span class="op">)</span>
<span class="co">#&gt; 16 </span>
<span class="co">#&gt; 16</span></code></pre></div>
<p>16番目のデータに対して，クックの距離は下がったが，<span class="math inline">\(PF_{(n, n-p)}=0.5)\)</span> 以上のままなので，課題としてのこります。</p>
<div id="応答変数以外の解決手法" class="section level3" number="8.10.1">
<h3>
<span class="header-section-number">8.10.1</span> 応答変数以外の解決手法<a class="anchor" aria-label="anchor" href="#%E5%BF%9C%E7%AD%94%E5%A4%89%E6%95%B0%E4%BB%A5%E5%A4%96%E3%81%AE%E8%A7%A3%E6%B1%BA%E6%89%8B%E6%B3%95"><i class="fas fa-link"></i></a>
</h3>
<p>応答変数をログ変換しても問題は解決できませんでした。
次に検討することは説明変数の変換または、削除です。
まずは，VIF の高い変数から外してみみます。</p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/vif.html">vif</a></span><span class="op">(</span><span class="va">logHF</span><span class="op">)</span>
<span class="co">#&gt;      Area Elevation   Nearest     Scruz  Adjacent </span>
<span class="co">#&gt;  2.928145  3.992545  1.766099  1.675031  1.826403</span></code></pre></div>
<p><code>Elevation</code> の値が一番高かったので，<code>Elevation</code> なしのモデルを再解析します。</p>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">logHF2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">logSpecies</span><span class="op">~</span> <span class="va">Area</span> <span class="op">+</span> <span class="va">Nearest</span> <span class="op">+</span> <span class="va">Scruz</span> <span class="op">+</span> <span class="va">Adjacent</span>, data <span class="op">=</span> <span class="va">gala</span><span class="op">)</span>
<span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/vif.html">vif</a></span><span class="op">(</span><span class="va">logHF2</span><span class="op">)</span>
<span class="co">#&gt;     Area  Nearest    Scruz Adjacent </span>
<span class="co">#&gt; 1.047496 1.669984 1.658583 1.073529</span></code></pre></div>
<p>診断図を確認したら，結果は良くなかったので，<code>Nearest</code> か <code>Scruz</code> も外します。
種数は島と島の間の距離に依存するかもしれないが，一つの島（Santa Cruz島）との距離の影響は考えにくいので，<code>Scruz</code> を外します。</p>
</div>
</div>
<div id="単純化したモデル" class="section level2" number="8.11">
<h2>
<span class="header-section-number">8.11</span> 単純化したモデル<a class="anchor" aria-label="anchor" href="#%E5%8D%98%E7%B4%94%E5%8C%96%E3%81%97%E3%81%9F%E3%83%A2%E3%83%87%E3%83%AB"><i class="fas fa-link"></i></a>
</h2>
<p>結果として，つぎのモデルを解析することになりました。</p>
<p><span class="math display">\[
E(\log(\text{Species})) = b_0 + b_1\text{Area}+b_2\text{Nearest}+b_3\text{Adjacent}
\]</span></p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">logSF</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">logSpecies</span><span class="op">~</span> <span class="va">Area</span> <span class="op">+</span> <span class="va">Nearest</span> <span class="op">+</span> <span class="va">Adjacent</span>, data <span class="op">=</span> <span class="va">gala</span><span class="op">)</span>
<span class="va">logSF</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"III"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; Anova Table (Type III tests)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Response: logSpecies</span>
<span class="co">#&gt;              Sum Sq Df F value    Pr(&gt;F)</span>
<span class="co">#&gt; (Intercept) 159.281  1 74.7879 3.983e-09</span>
<span class="co">#&gt; Area         13.201  1  6.1981   0.01951</span>
<span class="co">#&gt; Nearest       2.372  1  1.1139   0.30095</span>
<span class="co">#&gt; Adjacent      0.180  1  0.0847   0.77335</span>
<span class="co">#&gt; Residuals    55.374 26</span></code></pre></div>
<p><code>Area</code> 以外の変数のP値は 0.05 より高いです。</p>
</div>
<div id="診断図" class="section level2" number="8.12">
<h2>
<span class="header-section-number">8.12</span> 診断図<a class="anchor" aria-label="anchor" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fgala</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">logSF</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fgala</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.stdresid</span>, y <span class="op">=</span> <span class="va">..density..</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html">stat_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">dnorm</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Histogram"</span>, x <span class="op">=</span> <span class="st">"Standardized residual"</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> 
<span class="va">p2</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fgala</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html">geom_qq</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"QQ plot"</span>, x <span class="op">=</span> <span class="st">"Theoretical Quantile"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span> 
<span class="va">p3</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">logSpecies</span>, <span class="va">Area</span>, <span class="va">Nearest</span>, <span class="va">Adjacent</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Resid. vs. predictor"</span>, x <span class="op">=</span> <span class="st">"Predictor value"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span>
<span class="va">p4</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.fitted</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Resid. vs. fit"</span>, x <span class="op">=</span> <span class="st">"Fitted value"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span>
<span class="va">p5</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.fitted</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Scale - location"</span>, x <span class="op">=</span> <span class="st">"Fitted value"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span>
<span class="va">dof</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">logSF</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"df"</span><span class="op">)</span>
<span class="va">thold</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html">qf</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">p6</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>above <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.cooksd</span> <span class="op">&gt;</span> <span class="va">thold</span>, <span class="cn">T</span>, <span class="cn">F</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">.cooksd</span>, color <span class="op">=</span> <span class="va">above</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">thold</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Cook's distance"</span>, x <span class="op">=</span> <span class="st">"Index"</span>, y <span class="op">=</span> <span class="st">"Cook's distance"</span><span class="op">)</span>

<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span> <span class="op">+</span> <span class="va">p5</span> <span class="op">+</span> <span class="va">p6</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-40-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>残差のばらつきや正規性は良くなったが，クックの距離の問題が残っています。</p>
</div>
<div id="説明変数も変換する" class="section level2" number="8.13">
<h2>
<span class="header-section-number">8.13</span> 説明変数も変換する<a class="anchor" aria-label="anchor" href="#%E8%AA%AC%E6%98%8E%E5%A4%89%E6%95%B0%E3%82%82%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h2>
<p>こんどは，説明変数も変換します。</p>
<p><span class="math display">\[
E(\log(\text{Species})) = b_0 + b_1\log(\text{Area})+b_2\text{Nearest}+b_3\log(\text{Adjacent})
\]</span></p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gala</span> <span class="op">=</span> <span class="va">gala</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>logSpecies <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Species</span><span class="op">)</span>, logArea <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Area</span><span class="op">)</span>, logAdjacent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Adjacent</span><span class="op">)</span><span class="op">)</span>
<span class="va">logSF2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">logSpecies</span><span class="op">~</span> <span class="va">logArea</span> <span class="op">+</span> <span class="va">Nearest</span> <span class="op">+</span> <span class="va">logAdjacent</span>, data <span class="op">=</span> <span class="va">gala</span><span class="op">)</span>
<span class="va">logSF2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"III"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; Anova Table (Type III tests)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Response: logSpecies</span>
<span class="co">#&gt;              Sum Sq Df  F value    Pr(&gt;F)</span>
<span class="co">#&gt; (Intercept) 151.442  1 239.3574 1.247e-14</span>
<span class="co">#&gt; logArea      52.429  1  82.8653 1.445e-09</span>
<span class="co">#&gt; Nearest       0.618  1   0.9764    0.3322</span>
<span class="co">#&gt; logAdjacent   0.159  1   0.2512    0.6204</span>
<span class="co">#&gt; Residuals    16.450 26</span></code></pre></div>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fgala</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">logSF2</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fgala</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.stdresid</span>, y <span class="op">=</span> <span class="va">..density..</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html">stat_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">dnorm</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Histogram"</span>, x <span class="op">=</span> <span class="st">"Standardized residual"</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> 
<span class="va">p2</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fgala</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html">geom_qq</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"QQ plot"</span>, x <span class="op">=</span> <span class="st">"Theoretical Quantile"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span> 
<span class="va">p3</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">logSpecies</span>, <span class="va">logArea</span>, <span class="va">Nearest</span>, <span class="va">logAdjacent</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Resid. vs. predictor"</span>, x <span class="op">=</span> <span class="st">"Predictor value"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span>
<span class="va">p4</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.fitted</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Resid. vs. fit"</span>, x <span class="op">=</span> <span class="st">"Fitted value"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span>
<span class="va">p5</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.fitted</span>, <span class="va">.stdresid</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">.stdresid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Scale - location"</span>, x <span class="op">=</span> <span class="st">"Fitted value"</span>, y <span class="op">=</span> <span class="st">"Standardized residual"</span><span class="op">)</span>
<span class="va">dof</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">logSF</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"df"</span><span class="op">)</span>
<span class="va">thold</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html">qf</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">p6</span> <span class="op">=</span> <span class="va">fgala</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>above <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.cooksd</span> <span class="op">&gt;</span> <span class="va">thold</span>, <span class="cn">T</span>, <span class="cn">F</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">.cooksd</span>, color <span class="op">=</span> <span class="va">above</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">thold</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Cook's distance"</span>, x <span class="op">=</span> <span class="st">"Index"</span>, y <span class="op">=</span> <span class="st">"Cook's distance"</span><span class="op">)</span>

<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span> <span class="op">+</span> <span class="va">p5</span> <span class="op">+</span> <span class="va">p6</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-42-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>残差のばらつき，正規性，クックの距離の問題は解決できました。</p>
<p><strong>結果</strong></p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">logSF2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html">Anova</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"III"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; Anova Table (Type III tests)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Response: logSpecies</span>
<span class="co">#&gt;              Sum Sq Df  F value    Pr(&gt;F)</span>
<span class="co">#&gt; (Intercept) 151.442  1 239.3574 1.247e-14</span>
<span class="co">#&gt; logArea      52.429  1  82.8653 1.445e-09</span>
<span class="co">#&gt; Nearest       0.618  1   0.9764    0.3322</span>
<span class="co">#&gt; logAdjacent   0.159  1   0.2512    0.6204</span>
<span class="co">#&gt; Residuals    16.450 26</span></code></pre></div>
<p>帰無仮設の有意性検定によると，<code>logArea</code> と <code>Nearest</code> の効果は有意ですが，<code>logAdjacent</code> の効果は有意じゃない。</p>
<p>ところが，この結果まで導くには，5 種類のモデルを検証しました。<span class="math inline">\(\alpha_\text{fwer}\)</span> は
<span class="math inline">\(1 - (1-0.05)^5 = 0.2262\)</span> ですので，<span class="math inline">\(\alpha_\text{fwer}=0.05\)</span> にしたければ，<span class="math inline">\(\alpha = 0.0102\)</span> に設定しなければなりません。このとき，<code>logArea</code> 以外の要因の効果は有意ではありません。</p>
</div>
<div id="一般化線形モデル" class="section level2" number="8.14">
<h2>
<span class="header-section-number">8.14</span> 一般化線形モデル<a class="anchor" aria-label="anchor" href="#%E4%B8%80%E8%88%AC%E5%8C%96%E7%B7%9A%E5%BD%A2%E3%83%A2%E3%83%87%E3%83%AB"><i class="fas fa-link"></i></a>
</h2>
<p>一般化線形モデル (GLM) は今までの線型モデルと同じように，線型結合した変数から成り立っています。</p>
<p>さらに，</p>
<ul>
<li>正規分布を仮定した線型モデルのとき，予測残差は Residuals (残差) とよびましたが，GLMの予測残差は Deviance (尤離度・逸脱度・デビアンス) とよびます。</li>
<li>正規分布以外の指数型分布族にぞくする分布も使えます。</li>
<li>一般化線形モデルに 3 つの成分が存在します。
<ul>
<li>誤差構造または<strong>ランダム成分 (random component)</strong>
</li>
<li>
<strong>線型予測子 (linear predictor)</strong>または系統成分(systematic component)</li>
<li>連結関数または<strong>リンク関数 (link function)</strong>
</li>
</ul>
</li>
</ul>
</div>
<div id="指数型分布族誤差項" class="section level2" number="8.15">
<h2>
<span class="header-section-number">8.15</span> 指数型分布族・誤差項<a class="anchor" aria-label="anchor" href="#%E6%8C%87%E6%95%B0%E5%9E%8B%E5%88%86%E5%B8%83%E6%97%8F%E8%AA%A4%E5%B7%AE%E9%A0%85"><i class="fas fa-link"></i></a>
</h2>
<p><span class="math display">\[
f(y|\theta, \phi) = \exp\left(\frac {y\theta - b(\theta)} {a(\phi)} + c(y, \phi)\right)
\]</span></p>
<p><span class="math inline">\(\theta\)</span> は<strong>正準パラメータ (canonical parameter)</strong>，<span class="math inline">\(\phi\)</span> <strong>はばらつきのパラメータ (dispersion parameter, 分散パラメータ)</strong>，<span class="math inline">\(a(\cdot)\)</span>, <span class="math inline">\(b(\cdot)\)</span>, <span class="math inline">\(c(\cdot)\)</span> は存知の関数です。さらに，平均値は <span class="math inline">\(\mu = E(y) = b'(\theta)\)</span>，分散は <span class="math inline">\(var(y) = a(\phi) b''(\theta)\)</span> です。つまり，平均値は <span class="math inline">\(\theta\)</span> の関数できまるが，分散は二つの関数の積です。<span class="math inline">\(a(\phi) = \phi/w\)</span> であれば，<span class="math inline">\(v(y) = \phi b''(\theta)/w\)</span> であり，分散関数とよびます。正規分布の場合，分散と平均値は独立しているのと，<span class="math inline">\(\phi=1\)</span> なので，<span class="math inline">\(var(y) = 1/w\)</span> です。<span class="math inline">\(w\)</span> は存知の重みです。</p>
<div id="線形予測子または系統成分" class="section level3" number="8.15.1">
<h3>
<span class="header-section-number">8.15.1</span> 線形予測子または系統成分<a class="anchor" aria-label="anchor" href="#%E7%B7%9A%E5%BD%A2%E4%BA%88%E6%B8%AC%E5%AD%90%E3%81%BE%E3%81%9F%E3%81%AF%E7%B3%BB%E7%B5%B1%E6%88%90%E5%88%86"><i class="fas fa-link"></i></a>
</h3>
<p>応答変数における予測子の影響は次のように書けます。</p>
<p><span class="math display">\[
\eta = \beta_0 + \beta_1 x_1 + \cdots + \beta_n x_n
\]</span></p>
<p>この線形予測子は一般線形モデルと同じ用に構築します。</p>
</div>
<div id="連結関数-リンク関数" class="section level3" number="8.15.2">
<h3>
<span class="header-section-number">8.15.2</span> 連結関数 (リンク関数)<a class="anchor" aria-label="anchor" href="#%E9%80%A3%E7%B5%90%E9%96%A2%E6%95%B0-%E3%83%AA%E3%83%B3%E3%82%AF%E9%96%A2%E6%95%B0"><i class="fas fa-link"></i></a>
</h3>
<p>応答変数の期待値と予測子の関係はリンク関数を通して関係づけます。</p>
<p><span class="math display">\[
g(\mu) = \eta
\]</span></p>
<p>リンク関数は単調な微分可能な関数です。</p>
</div>
<div id="一般化線形モデルの推定方法" class="section level3" number="8.15.3">
<h3>
<span class="header-section-number">8.15.3</span> 一般化線形モデルの推定方法<a class="anchor" aria-label="anchor" href="#%E4%B8%80%E8%88%AC%E5%8C%96%E7%B7%9A%E5%BD%A2%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E6%8E%A8%E5%AE%9A%E6%96%B9%E6%B3%95"><i class="fas fa-link"></i></a>
</h3>
<p>一般化線形モデルのパラメータ推定には<strong>最尤推定 (maximum likelihood estimation; maximum likelihood method; 最尤推定法)</strong> を用います。</p>
<p><span class="math inline">\(y_1, \dots, y_n\)</span> は <span class="math inline">\(n\)</span> 数の独立な確率変数とします。さらに，<span class="math inline">\(y_i\)</span> は同じパラメータの正規分布に従うとしたら，同時確立分布はつぎの通りです。</p>
<p><span class="math display">\[
P(y_1, \dots, y_n | \mu, \sigma^2) = \prod_{i=1}^{N} \exp\left(y_i\frac{\mu}{\sigma^2} -\frac{\mu^2}{2\sigma^2} - \frac{1}{2}\log(2\pi\sigma^2) -\frac{y_i^2}{2\sigma^2}\right) = \mathcal{L}(\mu, \sigma^2 | y_1, \dots, y_n)
\]</span></p>
<p>ここの <span class="math inline">\(\mathcal{L}(\cdots)\)</span> が<strong>尤度関数 (log-likelihood function)</strong>。両側の自然対数を求めれば，<strong>対数尤度関数 (log-likelihood function)</strong> に導きます。</p>
<p><span class="math display">\[
\log(\mathcal{L}(\mu,\sigma^2)) = - \frac{n}{2}\log(2\pi\sigma^2)-\frac{1}{2\sigma^2}\sum_{i=1}^{N}(y_i - \mu)^2
\]</span></p>
<p>この対数尤度関数が最大または<strong>負の対数尤度関数 (negative log-likelihood function)</strong> が最小になるパラメータをさがすことが目的です。</p>
</div>
<div id="一般的な誤差項" class="section level3" number="8.15.4">
<h3>
<span class="header-section-number">8.15.4</span> 一般的な誤差項<a class="anchor" aria-label="anchor" href="#%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E8%AA%A4%E5%B7%AE%E9%A0%85"><i class="fas fa-link"></i></a>
</h3>
<p><strong>連続型確率分布</strong></p>
<ul>
<li>正規分布</li>
<li>ガンマ分布</li>
<li>ベータ分布</li>
<li>指数分布</li>
</ul>
<p><strong>離散型確率分布</strong></p>
<ul>
<li>ポアソン分布</li>
<li>二項分布</li>
<li>負の二項分布</li>
<li>categorical 分布</li>
</ul>
<p>他にありますが，上記の分布が一般的につかわれています。</p>
</div>
</div>
<div id="ガラパゴス諸島のデータのglm解析例" class="section level2" number="8.16">
<h2>
<span class="header-section-number">8.16</span> ガラパゴス諸島のデータのGLM解析例<a class="anchor" aria-label="anchor" href="#%E3%82%AC%E3%83%A9%E3%83%91%E3%82%B4%E3%82%B9%E8%AB%B8%E5%B3%B6%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AEglm%E8%A7%A3%E6%9E%90%E4%BE%8B"><i class="fas fa-link"></i></a>
</h2>
<p>まず，帰無仮設の気無モデル（ヌルモデル）を組み立てます。</p>
<p><span class="math display">\[
\begin{aligned}
\text{Species} &amp;\sim Pois(\mu)\\
E(\text{Species}) &amp;= \mu \\
E(\text{Species}) &amp;= \exp(\eta) \\
\eta &amp;= b_0  \\
\end{aligned}
\]</span></p>
<p><span class="math inline">\(\eta = b_0\)</span> は切片のみのモデルです。</p>
<div id="ポアソンglm解析の出力" class="section level3" number="8.16.1">
<h3>
<span class="header-section-number">8.16.1</span> ポアソンGLM解析の出力<a class="anchor" aria-label="anchor" href="#%E3%83%9D%E3%82%A2%E3%82%BD%E3%83%B3glm%E8%A7%A3%E6%9E%90%E3%81%AE%E5%87%BA%E5%8A%9B"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">H0_poisson</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">gala</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span><span class="op">)</span>
<span class="va">H0_poisson</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; glm(formula = Species ~ 1, family = poisson(link = "log"), data = gala)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Deviance Residuals: </span>
<span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span>
<span class="co">#&gt; -12.307   -9.782   -5.200    1.142   27.351  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)</span>
<span class="co">#&gt; (Intercept)  4.44539    0.01978   224.8   &lt;2e-16</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; (Dispersion parameter for poisson family taken to be 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Null deviance: 3510.7  on 29  degrees of freedom</span>
<span class="co">#&gt; Residual deviance: 3510.7  on 29  degrees of freedom</span>
<span class="co">#&gt; AIC: 3673.6</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of Fisher Scoring iterations: 6</span></code></pre></div>
<p>パラメータの推定量の表の後に，(Dispersion parameter for poisson family taken to be 1) の記述があります。
これは，ポアソン分布のばらつきのパラメータ <span class="math inline">\((\phi)\)</span> を 1 に設定したと意味します。
ヌルモデルを当てはめたので，ヌル逸脱度 (Null Deviance) と残渣逸脱度 (Residual Deviance) は同じです。</p>
</div>
<div id="対立モデル" class="section level3" number="8.16.2">
<h3>
<span class="header-section-number">8.16.2</span> 対立モデル<a class="anchor" aria-label="anchor" href="#%E5%AF%BE%E7%AB%8B%E3%83%A2%E3%83%87%E3%83%AB"><i class="fas fa-link"></i></a>
</h3>
<p>次は対立モデルです。</p>
<p><span class="math display">\[
\begin{aligned}
\text{Species} &amp;\sim Pois(\mu)\\
E(\text{Species}) &amp;= \mu \\
E(\text{Species}) &amp;= \exp(\eta) \\
\eta &amp;= b_0 + b_1\text{Area}+b_2\text{Elevation}+b_3\text{Nearest}+b_4\text{Scruz}+b_5\text{Adjacent}\\
\end{aligned}
\]</span></p>
</div>
<div id="対立モデルの出力" class="section level3" number="8.16.3">
<h3>
<span class="header-section-number">8.16.3</span> 対立モデルの出力<a class="anchor" aria-label="anchor" href="#%E5%AF%BE%E7%AB%8B%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E5%87%BA%E5%8A%9B"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">HF_poisson</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">Area</span> <span class="op">+</span> <span class="va">Elevation</span> <span class="op">+</span> <span class="va">Nearest</span> <span class="op">+</span> <span class="va">Scruz</span> <span class="op">+</span> <span class="va">Adjacent</span>, 
                 data <span class="op">=</span> <span class="va">gala</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span><span class="op">)</span>
<span class="va">HF_poisson</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; glm(formula = Species ~ Area + Elevation + Nearest + Scruz + </span>
<span class="co">#&gt;     Adjacent, family = poisson(link = "log"), data = gala)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Deviance Residuals: </span>
<span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span>
<span class="co">#&gt; -8.2752  -4.4966  -0.9443   1.9168  10.1849  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;               Estimate Std. Error z value Pr(&gt;|z|)</span>
<span class="co">#&gt; (Intercept)  3.155e+00  5.175e-02  60.963  &lt; 2e-16</span>
<span class="co">#&gt; Area        -5.799e-04  2.627e-05 -22.074  &lt; 2e-16</span>
<span class="co">#&gt; Elevation    3.541e-03  8.741e-05  40.507  &lt; 2e-16</span>
<span class="co">#&gt; Nearest      8.826e-03  1.821e-03   4.846 1.26e-06</span>
<span class="co">#&gt; Scruz       -5.709e-03  6.256e-04  -9.126  &lt; 2e-16</span>
<span class="co">#&gt; Adjacent    -6.630e-04  2.933e-05 -22.608  &lt; 2e-16</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; (Dispersion parameter for poisson family taken to be 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Null deviance: 3510.73  on 29  degrees of freedom</span>
<span class="co">#&gt; Residual deviance:  716.85  on 24  degrees of freedom</span>
<span class="co">#&gt; AIC: 889.68</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></code></pre></div>
<p>最初に当てはめた線形モデルの結果と全く違います。</p>
</div>
</div>
<div id="尤度比検定とaicにおけるモデル比較" class="section level2" number="8.17">
<h2>
<span class="header-section-number">8.17</span> 尤度比検定とAICにおけるモデル比較<a class="anchor" aria-label="anchor" href="#%E5%B0%A4%E5%BA%A6%E6%AF%94%E6%A4%9C%E5%AE%9A%E3%81%A8aic%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%A2%E3%83%87%E3%83%AB%E6%AF%94%E8%BC%83"><i class="fas fa-link"></i></a>
</h2>
<p>今までは，正規分布を仮定した解析手法をつかっていたので，比較はF検定で行いました。
ポアソンGLMののとき，尤度比検定で，帰無モデル（ヌルモデル）と対立モデルを比較します。</p>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="va">H0_poisson</span>, <span class="va">HF_poisson</span>, test <span class="op">=</span> <span class="st">"LRT"</span><span class="op">)</span>
<span class="co">#&gt; Analysis of Deviance Table</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model 1: Species ~ 1</span>
<span class="co">#&gt; Model 2: Species ~ Area + Elevation + Nearest + Scruz + Adjacent</span>
<span class="co">#&gt;   Resid. Df Resid. Dev Df Deviance  Pr(&gt;Chi)    </span>
<span class="co">#&gt; 1        29     3510.7                          </span>
<span class="co">#&gt; 2        24      716.8  5   2793.9 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  </span>
<span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></code></pre></div>
<p><strong>AICでも比較できます。</strong></p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span><span class="op">(</span><span class="va">H0_poisson</span>, <span class="va">HF_poisson</span><span class="op">)</span>
<span class="co">#&gt;            df       AIC</span>
<span class="co">#&gt; H0_poisson  1 3673.5596</span>
<span class="co">#&gt; HF_poisson  6  889.6767</span></code></pre></div>
<p>尤度比検定のとき，NHSTの検証になるので，帰無仮設を棄却することになります。
AICのとき，モデル選択するので，AICの最も低いモデルを採択します。
正規分布やガンマ分布などの他の分布をつかったときでも，尤度比検定やAICを用いてもいいです。
もちろん，正規分布の場合，F検定でも問題はありません (このとき，<code>test = "F"</code>)。</p>
<div id="ポアソン分布のときに必ず確認する値" class="section level3" number="8.17.1">
<h3>
<span class="header-section-number">8.17.1</span> ポアソン分布のときに必ず確認する値<a class="anchor" aria-label="anchor" href="#%E3%83%9D%E3%82%A2%E3%82%BD%E3%83%B3%E5%88%86%E5%B8%83%E3%81%AE%E3%81%A8%E3%81%8D%E3%81%AB%E5%BF%85%E3%81%9A%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E5%80%A4"><i class="fas fa-link"></i></a>
</h3>
<p>ポアソン分布のGLMを実施したあと，<strong>必ず確認しなければならい値は過分散 (over-dispersion)</strong>です。
過分散があるとき，パラメータの標準誤差，信頼区間，モデルの予測値は誤っています。
過分散をパラメータとして推定するモデル（正規分布やガンマ分布など）の場合は，過分散の推定を無視できます。</p>
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html</span>
<span class="va">overdisp_fun</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">rdf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/df.residual.html">df.residual</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>
    <span class="va">rp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">model</span>,type<span class="op">=</span><span class="st">"pearson"</span><span class="op">)</span>
    <span class="va">Pearson.chisq</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rp</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
    <span class="va">prat</span> <span class="op">=</span> <span class="va">Pearson.chisq</span><span class="op">/</span><span class="va">rdf</span>
    <span class="va">pval</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">Pearson.chisq</span>, df<span class="op">=</span><span class="va">rdf</span>, lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
    <span class="va">mu</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mu<span class="op">=</span><span class="va">mu</span>, chisq<span class="op">=</span><span class="va">Pearson.chisq</span>,ratio<span class="op">=</span><span class="va">prat</span>,rdf<span class="op">=</span><span class="va">rdf</span>,p<span class="op">=</span><span class="va">pval</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">overdisp_fun</span><span class="op">(</span><span class="va">HF_poisson</span><span class="op">)</span>
<span class="co">#&gt;            mu         chisq         ratio           rdf </span>
<span class="co">#&gt;  8.523333e+01  7.619792e+02  3.174914e+01  2.400000e+01 </span>
<span class="co">#&gt;             p </span>
<span class="co">#&gt; 2.187190e-145</span></code></pre></div>
<p>感覚的に考えると，モデル結果の Residual Deviance の値が degrees of freedom の値と同じであれば，過分散は存在しません。
ただし，どの手法をつかっても，平均値は 5 以上じゃなければなりません。
上記のP値はとても小さいので，過分散が存在すると考えられます。
または，Residual Deviance (761.98) は自由度 (24) より大きいので，検定をしなくても過分散の問題は明らかです
過分散はデータがポアソン分布に従わないときとモデル変数が不十分なときに起こります。過小分散も存在しますが，過分散ほどの問題ではありません。</p>
</div>
<div id="モデルの改良" class="section level3" number="8.17.2">
<h3>
<span class="header-section-number">8.17.2</span> モデルの改良<a class="anchor" aria-label="anchor" href="#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E6%94%B9%E8%89%AF"><i class="fas fa-link"></i></a>
</h3>
<p>過分散の問題があったので，診断図を確認するよりも，他のモデルを当てはめてみます。
ここでは説明変数のログ変換したモデルを解析します。</p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">H2_poisson</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">logArea</span> <span class="op">+</span> <span class="va">Nearest</span> <span class="op">+</span> <span class="va">logAdjacent</span>, 
                 data <span class="op">=</span> <span class="va">gala</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span><span class="op">)</span>
<span class="va">H2_poisson</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; glm(formula = Species ~ logArea + Nearest + logAdjacent, family = poisson(link = "log"), </span>
<span class="co">#&gt;     data = gala)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Deviance Residuals: </span>
<span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span>
<span class="co">#&gt; -5.6281  -3.4817  -0.3344   2.7419   8.2056  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;              Estimate Std. Error z value Pr(&gt;|z|)</span>
<span class="co">#&gt; (Intercept)  3.361898   0.046784  71.860  &lt; 2e-16</span>
<span class="co">#&gt; logArea      0.371771   0.007961  46.698  &lt; 2e-16</span>
<span class="co">#&gt; Nearest     -0.006244   0.001312  -4.759 1.94e-06</span>
<span class="co">#&gt; logAdjacent -0.097529   0.006106 -15.974  &lt; 2e-16</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; (Dispersion parameter for poisson family taken to be 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Null deviance: 3510.73  on 29  degrees of freedom</span>
<span class="co">#&gt; Residual deviance:  371.78  on 26  degrees of freedom</span>
<span class="co">#&gt; AIC: 540.61</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></code></pre></div>
<p>Residual deviance と degrees of freedom を確認すると，<span class="math inline">\(371.78\; /\; 26 &gt; 1\)</span> なので，過分散が残っています。
ガラパゴス諸島の種数のデータに対して，どのように変換を変換しても，過分散は <span class="math inline">\(&gt;1\)</span> です。</p>
</div>
<div id="過分散をパラメータとして扱う" class="section level3" number="8.17.3">
<h3>
<span class="header-section-number">8.17.3</span> 過分散をパラメータとして扱う<a class="anchor" aria-label="anchor" href="#%E9%81%8E%E5%88%86%E6%95%A3%E3%82%92%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%81%A8%E3%81%97%E3%81%A6%E6%89%B1%E3%81%86"><i class="fas fa-link"></i></a>
</h3>
<p>何をしても過分散が残るとき，過分散をパラメータ化することができます。
ポアソン分布で説明できなかった分散を負の二項分布で説明できるかもしれません。</p>
<p><strong>【重要】</strong><code>MASS</code> パッケージの<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> 関数は <code>tidyverse</code> の <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> 関数と同じ名前なので、
あとに読み込んだパッケージの関すが優先されます。
つまり、<code>MASS</code> パッケージは <code>tidyverse</code> の先に読み込みましょう。
あるいは、不要になったらディタッチ (detach) しましょう。</p>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">package</span><span class="op">:</span><span class="va">MASS</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">H2_negbinom</span> <span class="op">=</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">logArea</span> <span class="op">+</span> <span class="va">Nearest</span> <span class="op">+</span> <span class="va">logAdjacent</span>, data <span class="op">=</span> <span class="va">gala</span>, link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>
<span class="va">H2_negbinom</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>signif.stars <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; MASS::glm.nb(formula = Species ~ logArea + Nearest + logAdjacent, </span>
<span class="co">#&gt;     data = gala, link = "log", init.theta = 2.83714993)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Deviance Residuals: </span>
<span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span>
<span class="co">#&gt; -2.2174  -0.9672  -0.3006   0.5165   2.0350  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;              Estimate Std. Error z value Pr(&gt;|z|)</span>
<span class="co">#&gt; (Intercept)  3.369739   0.157235  21.431   &lt;2e-16</span>
<span class="co">#&gt; logArea      0.364309   0.035028  10.400   &lt;2e-16</span>
<span class="co">#&gt; Nearest     -0.012389   0.008211  -1.509    0.131</span>
<span class="co">#&gt; logAdjacent -0.034399   0.036005  -0.955    0.339</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; (Dispersion parameter for Negative Binomial(2.8371) family taken to be 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Null deviance: 144.45  on 29  degrees of freedom</span>
<span class="co">#&gt; Residual deviance:  32.82  on 26  degrees of freedom</span>
<span class="co">#&gt; AIC: 284.88</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of Fisher Scoring iterations: 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;               Theta:  2.837 </span>
<span class="co">#&gt;           Std. Err.:  0.830 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  2 x log-likelihood:  -274.884</span></code></pre></div>
<p>誤差項の分布は負の二項分布にしたので，分散は <span class="math inline">\(Variance = \mu + \frac{\mu}{\theta}\)</span> として推定されます。
このモデルの<span class="math inline">\(\theta\)</span> は 2.8371 です。
このモデルの解析を進めたいので，次は診断図の確認です。</p>
</div>
<div id="負の二項分布glmの診断図" class="section level3" number="8.17.4">
<h3>
<span class="header-section-number">8.17.4</span> 負の二項分布GLMの診断図<a class="anchor" aria-label="anchor" href="#%E8%B2%A0%E3%81%AE%E4%BA%8C%E9%A0%85%E5%88%86%E5%B8%83glm%E3%81%AE%E8%A8%BA%E6%96%AD%E5%9B%B3"><i class="fas fa-link"></i></a>
</h3>
<p>診断図はよくつくるので、診断図用の関数を定義します。</p>
</div>
<div id="診断図関数残差のヒストグラム" class="section level3" number="8.17.5">
<h3>
<span class="header-section-number">8.17.5</span> 診断図関数：残差のヒストグラム<a class="anchor" aria-label="anchor" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E6%AE%8B%E5%B7%AE%E3%81%AE%E3%83%92%E3%82%B9%E3%83%88%E3%82%B0%E3%83%A9%E3%83%A0"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 残差のヒストグラム</span>
<span class="va">gg_resid_hist</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">tidyvers</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">statmod</span><span class="op">)</span>
  <span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>qresid <span class="op">=</span> <span class="fu">statmod</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/statmod/man/qresiduals.html">qresiduals</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">)</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residual <span class="op">=</span> <span class="va">qresid</span><span class="op">)</span>
    <span class="va">xlabel</span> <span class="op">=</span> <span class="st">"Randomized Quantile Residuals"</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residual <span class="op">=</span> <span class="va">.resid</span><span class="op">)</span>
    <span class="va">xlabel</span> <span class="op">=</span> <span class="st">"Standardized Residuals"</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">residual</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">xlabel</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Histogram of Residuals"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="診断図関数残差のqqプロット" class="section level3" number="8.17.6">
<h3>
<span class="header-section-number">8.17.6</span> 診断図関数：残差のQQプロット<a class="anchor" aria-label="anchor" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E6%AE%8B%E5%B7%AE%E3%81%AEqq%E3%83%97%E3%83%AD%E3%83%83%E3%83%88"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 残差のQQプロット</span>
<span class="va">gg_qq</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">tidyvers</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">statmod</span><span class="op">)</span>
  <span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>
   <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>qresid <span class="op">=</span> <span class="fu">statmod</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/statmod/man/qresiduals.html">qresiduals</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">)</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residual <span class="op">=</span> <span class="va">qresid</span><span class="op">)</span>
    <span class="va">ylabel</span> <span class="op">=</span> <span class="st">"Randomized Quantile Residuals"</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residual <span class="op">=</span> <span class="va">.stdresid</span><span class="op">)</span>
    <span class="va">ylabel</span> <span class="op">=</span> <span class="st">"Standardized Residuals"</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html">geom_qq</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>sample <span class="op">=</span><span class="va">residual</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Theoretical Quantile"</span>, y <span class="op">=</span> <span class="va">ylabel</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Normal-QQ Plot"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="診断図関数変数に対する残差のばらつき" class="section level3" number="8.17.7">
<h3>
<span class="header-section-number">8.17.7</span> 診断図関数：変数に対する残差のばらつき<a class="anchor" aria-label="anchor" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E5%A4%89%E6%95%B0%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E6%AE%8B%E5%B7%AE%E3%81%AE%E3%81%B0%E3%82%89%E3%81%A4%E3%81%8D"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 変数に対する残差のプロット</span>
<span class="va">gg_resX</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fitted.model</span>, <span class="va">ncol</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">tidyvers</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">statmod</span><span class="op">)</span>
  <span class="va">residlab</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">string</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Residuals vs. %s"</span>, <span class="va">string</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">varnames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
  <span class="va">varnames</span> <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="va">varnames</span>, <span class="st">" \\+ "</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>qresid <span class="op">=</span> <span class="fu">statmod</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/statmod/man/qresiduals.html">qresiduals</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">)</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residual <span class="op">=</span> <span class="va">qresid</span><span class="op">)</span>
    <span class="va">ylabel</span> <span class="op">=</span> <span class="st">"Randomized Quantile Residuals"</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residual <span class="op">=</span> <span class="va">.resid</span><span class="op">)</span>
    <span class="va">ylabel</span> <span class="op">=</span> <span class="st">"Standardized Residuals"</span>
  <span class="op">}</span>
  <span class="va">varnames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">varnames</span><span class="op">]</span>
  <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">varnames</span>, <span class="va">residual</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="va">var</span>, <span class="va">value</span>, <span class="va">varnames</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">residual</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">0</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Value"</span>, y <span class="op">=</span> <span class="va">ylabel</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="st">"var"</span>, labeller<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labeller.html">labeller</a></span><span class="op">(</span>var<span class="op">=</span><span class="va">residlab</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_x"</span>,
               ncol <span class="op">=</span> <span class="va">ncol</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="診断図関数期待値に対する残差のばらつき" class="section level3" number="8.17.8">
<h3>
<span class="header-section-number">8.17.8</span> 診断図関数：期待値に対する残差のばらつき<a class="anchor" aria-label="anchor" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E6%9C%9F%E5%BE%85%E5%80%A4%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E6%AE%8B%E5%B7%AE%E3%81%AE%E3%81%B0%E3%82%89%E3%81%A4%E3%81%8D"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 期待値に対する残差のプロット</span>
<span class="va">gg_resfitted</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">tidyvers</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">statmod</span><span class="op">)</span>
  <span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>qresid <span class="op">=</span> <span class="fu">statmod</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/statmod/man/qresiduals.html">qresiduals</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">)</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residual <span class="op">=</span> <span class="va">qresid</span><span class="op">)</span>
    <span class="va">ylabel</span> <span class="op">=</span> <span class="st">"Randomized Quantile Residuals"</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residual <span class="op">=</span> <span class="va">.resid</span><span class="op">)</span>
    <span class="va">ylabel</span> <span class="op">=</span> <span class="st">"Standardized Residuals"</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="va">residual</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">0</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Fitted Values"</span>, y <span class="op">=</span> <span class="va">ylabel</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Residuals vs. Fitted Values"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="診断図関数スケールロケーションプロット" class="section level3" number="8.17.9">
<h3>
<span class="header-section-number">8.17.9</span> 診断図関数：スケール・ロケーションプロット<a class="anchor" aria-label="anchor" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%AB%E3%83%AD%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%97%E3%83%AD%E3%83%83%E3%83%88"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># スケール・ロケーションプロット</span>
<span class="va">gg_scalelocation</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">tidyvers</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">statmod</span><span class="op">)</span>
  <span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>qresid <span class="op">=</span> <span class="fu">statmod</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/statmod/man/qresiduals.html">qresiduals</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span><span class="op">)</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residual <span class="op">=</span> <span class="va">qresid</span><span class="op">)</span>
    <span class="va">ylabel</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="st">"|RQR|"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residual <span class="op">=</span> <span class="va">.resid</span><span class="op">)</span>
    <span class="va">ylabel</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="st">"|Standardized Residuals|"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">residual</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">residual</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
                se <span class="op">=</span> <span class="cn">F</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Fitted Values"</span>, y <span class="op">=</span> <span class="va">ylabel</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Scale - Location Plot"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="診断図関数クックの距離" class="section level3" number="8.17.10">
<h3>
<span class="header-section-number">8.17.10</span> 診断図関数：クックの距離<a class="anchor" aria-label="anchor" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E3%82%AF%E3%83%83%E3%82%AF%E3%81%AE%E8%B7%9D%E9%9B%A2"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># クックの距離</span>
<span class="va">gg_cooksd</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">tidyvers</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">statmod</span><span class="op">)</span>
  <span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">data</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">.cooksd</span><span class="op">)</span><span class="op">)</span>
  <span class="va">dof</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"df"</span><span class="op">)</span>
  <span class="va">thold</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html">qf</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">dof</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
  <span class="va">data2</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>above <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.cooksd</span> <span class="op">&gt;</span> <span class="va">thold</span>, <span class="cn">T</span>, <span class="cn">F</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">above</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">.cooksd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="fl">0</span>, xend <span class="op">=</span> <span class="va">n</span>, yend <span class="op">=</span> <span class="va">.cooksd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="va">thold</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">.cooksd</span>, label <span class="op">=</span> <span class="va">n</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data2</span>, nudge_x<span class="op">=</span><span class="fl">3</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Sample"</span>, y <span class="op">=</span> <span class="st">"Cook's Distance"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Cook's Distance Plot"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>残差の確認は線形モデルと同じようにしますが，<a href="http://www.statsci.org/smyth/pubs/residual.html">解析に使う残差は ダン=スミス残差 (Dunn-Smyth Residuals; randomized quantile residuals) です</a>。
とくに，ポアソンGLMと疑似ポアソンGLMのダン=スミス残差を求めます。
ダン=スミス残差は残差の累積分布関数を用いて残差のランダム化を行います。
ランダム化した残差は正規分布に近似するので，QQプロットで使用した分布のよさを評価できます。
]ランダム化残差が直線に沿っていたら，分布に問題がないと示唆します。
左側はポアソン分布GLMのランダム化残差のQQプロットです。右側は負の二項分布GLMのランダム化残差のQQプロットです。</p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p1</span> <span class="op">=</span> <span class="fu">gg_qq</span><span class="op">(</span><span class="va">H2_poisson</span><span class="op">)</span>
<span class="va">p2</span> <span class="op">=</span> <span class="fu">gg_qq</span><span class="op">(</span><span class="va">H2_negbinom</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-58-1.png" width="90%" style="display: block; margin: auto;"></div>
</div>
<div id="η-に対するランダム化残差のばらつき" class="section level3" number="8.17.11">
<h3>
<span class="header-section-number">8.17.11</span> η に対するランダム化残差のばらつき<a class="anchor" aria-label="anchor" href="#%CE%B7-%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%83%A9%E3%83%B3%E3%83%80%E3%83%A0%E5%8C%96%E6%AE%8B%E5%B7%AE%E3%81%AE%E3%81%B0%E3%82%89%E3%81%A4%E3%81%8D"><i class="fas fa-link"></i></a>
</h3>
<p>ランダム化残差と <span class="math inline">\(\eta\)</span> の間に明確な関係はありません。
<span class="math inline">\(\sqrt{\left(|\text{Randomized Quantile Residuals}~\right)}\)</span> は若干山形な形をしています。
ところが，期待値の両端のデータが点線を引っ張っているように見えるので，
明確ではない。</p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p1</span> <span class="op">=</span> <span class="fu">gg_resfitted</span><span class="op">(</span><span class="va">H2_negbinom</span><span class="op">)</span>
<span class="va">p2</span> <span class="op">=</span> <span class="fu">gg_scalelocation</span><span class="op">(</span><span class="va">H2_negbinom</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-59-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>全てクックの距離は<span class="math inline">\(P(F_{(n, n-p)}=0.5)\)</span> より低いので，モデルを引っ張る点はありません。</p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">gg_cooksd</span><span class="op">(</span><span class="va">H2_negbinom</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="結果" class="section level2" number="8.18">
<h2>
<span class="header-section-number">8.18</span> 結果<a class="anchor" aria-label="anchor" href="#%E7%B5%90%E6%9E%9C"><i class="fas fa-link"></i></a>
</h2>
<p>診断図と過分散の確認から，次のモデルにたどり着きました。</p>
<p><span class="math display">\[
\begin{aligned}
\text{Species} &amp;\sim NegBin(\mu)\\
E(\text{Species}) &amp;= \mu \\
E(\text{Species}) &amp;= \exp(\eta) \\
Variance &amp;= \mu + \frac{\mu}{\theta} \\
\eta &amp;= b_0 + b_1\log(\text{Area})+b_3\text{Nearest}+b_5\log(\text{Adjacent})\\
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span><span class="op">(</span><span class="va">H2_poisson</span>, <span class="va">H2_negbinom</span><span class="op">)</span>
<span class="co">#&gt;             df      AIC</span>
<span class="co">#&gt; H2_poisson   4 540.6134</span>
<span class="co">#&gt; H2_negbinom  5 284.8838</span></code></pre></div>
<p>ポアソン分布GLMのAICが高いので，負の二項分布GLMを採択します。</p>
<!-- \note[item]{\href{https://stats.stackexchange.com/questions/157575/why-is-the-quasi-poisson-in-glm-not-treated-as-a-special-case-of-negative-binomi}{Quasipoisson and negative binomial model}} -->
<div id="負の二項分布の結果係数表" class="section level3" number="8.18.1">
<h3>
<span class="header-section-number">8.18.1</span> 負の二項分布の結果（係数表）<a class="anchor" aria-label="anchor" href="#%E8%B2%A0%E3%81%AE%E4%BA%8C%E9%A0%85%E5%88%86%E5%B8%83%E3%81%AE%E7%B5%90%E6%9E%9C%E4%BF%82%E6%95%B0%E8%A1%A8"><i class="fas fa-link"></i></a>
</h3>
<p>係数表だけ出力しました。</p>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">H2_negbinom</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt;             Estimate Std. Error z value  Pr(&gt;|z|)</span>
<span class="co">#&gt; (Intercept)   3.3697    0.15723  21.431 6.83e-102</span>
<span class="co">#&gt; logArea       0.3643    0.03503  10.400  2.47e-25</span>
<span class="co">#&gt; Nearest      -0.0124    0.00821  -1.509  1.31e-01</span>
<span class="co">#&gt; logAdjacent  -0.0344    0.03600  -0.955  3.39e-01</span>
<span class="co"># H2_negbinom %&gt;% summary() # 全情報の出力</span></code></pre></div>
<p>切片と <code>logArea</code> の効果ははっきりしています (P &lt; 0.0001)。ところが，<code>Nearest</code> と <code>logAdjacent</code> のP値は <span class="math inline">\(&gt;0.05\)</span> でした。
さらに，変数をへらしてもAICは大きく変わりません。</p>
</div>
<div id="aic" class="section level3" number="8.18.2">
<h3>
<span class="header-section-number">8.18.2</span> AIC<a class="anchor" aria-label="anchor" href="#aic"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">H2_negbinom2</span> <span class="op">=</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">logArea</span> <span class="op">+</span> <span class="va">Nearest</span> , data <span class="op">=</span> <span class="va">gala</span>, link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>
<span class="va">H2_negbinom3</span> <span class="op">=</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">logArea</span> <span class="op">+</span>  <span class="va">logAdjacent</span>, data <span class="op">=</span> <span class="va">gala</span>, link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>
<span class="va">H2_negbinom4</span> <span class="op">=</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">logArea</span> , data <span class="op">=</span> <span class="va">gala</span>, link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span><span class="op">(</span><span class="va">H2_negbinom</span>, <span class="va">H2_negbinom2</span>, <span class="va">H2_negbinom3</span>, <span class="va">H2_negbinom4</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">AIC</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 4 × 3</span>
<span class="co">#&gt;   model           df   AIC</span>
<span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 H2_negbinom2     4  284.</span>
<span class="co">#&gt; 2 H2_negbinom4     3  284.</span>
<span class="co">#&gt; 3 H2_negbinom      5  285.</span>
<span class="co">#&gt; 4 H2_negbinom3     4  285.</span></code></pre></div>
<p>最も小さいAICは <code>H2_negbinom2</code> になりましたがAICがの差が 0 ~ 7 の範囲に入るので，どのモデルでもいいです。
このとき，尤度比検定もした方がいい。</p>
</div>
<div id="尤度比検定" class="section level3" number="8.18.3">
<h3>
<span class="header-section-number">8.18.3</span> 尤度比検定<a class="anchor" aria-label="anchor" href="#%E5%B0%A4%E5%BA%A6%E6%AF%94%E6%A4%9C%E5%AE%9A"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="va">H2_negbinom</span>, <span class="va">H2_negbinom2</span>, <span class="va">H2_negbinom3</span>, <span class="va">H2_negbinom4</span>, test <span class="op">=</span> <span class="st">"LRT"</span><span class="op">)</span>
<span class="co">#&gt; Likelihood ratio tests of Negative Binomial Models</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Response: Species</span>
<span class="co">#&gt;                             Model    theta Resid. df</span>
<span class="co">#&gt; 1                         logArea 2.533343        28</span>
<span class="co">#&gt; 2               logArea + Nearest 2.730433        27</span>
<span class="co">#&gt; 3           logArea + logAdjacent 2.619569        27</span>
<span class="co">#&gt; 4 logArea + Nearest + logAdjacent 2.837150        26</span>
<span class="co">#&gt;      2 x log-lik.   Test    df  LR stat.   Pr(Chi)</span>
<span class="co">#&gt; 1       -277.7721                                 </span>
<span class="co">#&gt; 2       -275.7711 1 vs 2     1  2.000994 0.1571961</span>
<span class="co">#&gt; 3       -276.9859 2 vs 3     0 -1.214826 1.0000000</span>
<span class="co">#&gt; 4       -274.8838 3 vs 4     1  2.102117 0.1470954</span></code></pre></div>
<p>自由度の高い順からペア毎の尤度比検定を行っています。<span class="math inline">\(E(\text{Species})\sim b_0 + b_1\text{logArea}\)</span> のモデルでいいかもしれないです。</p>
</div>
<div id="モデル診断図" class="section level3" number="8.18.4">
<h3>
<span class="header-section-number">8.18.4</span> モデル診断図<a class="anchor" aria-label="anchor" href="#%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%BA%E6%96%AD%E5%9B%B3"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p1</span> <span class="op">=</span> <span class="fu">gg_qq</span><span class="op">(</span><span class="va">H2_negbinom4</span><span class="op">)</span>
<span class="va">p2</span> <span class="op">=</span> <span class="fu">gg_resX</span><span class="op">(</span><span class="va">H2_negbinom4</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">p3</span> <span class="op">=</span> <span class="fu">gg_resfitted</span><span class="op">(</span><span class="va">H2_negbinom4</span><span class="op">)</span>
<span class="va">p4</span> <span class="op">=</span> <span class="fu">gg_cooksd</span><span class="op">(</span><span class="va">H2_negbinom4</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-65-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>モデル診断図を確認したら，残差の問題はないですので，<span class="math inline">\(E(\text{Species})\sim b_0 + b_1\text{logArea}\)</span> のモデルを採択することになりました。</p>
</div>
<div id="採択したモデル" class="section level3" number="8.18.5">
<h3>
<span class="header-section-number">8.18.5</span> 採択したモデル<a class="anchor" aria-label="anchor" href="#%E6%8E%A1%E6%8A%9E%E3%81%97%E3%81%9F%E3%83%A2%E3%83%87%E3%83%AB"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">H2_negbinom4</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; MASS::glm.nb(formula = Species ~ logArea, data = gala, link = "log", </span>
<span class="co">#&gt;     init.theta = 2.533342912)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Deviance Residuals: </span>
<span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span>
<span class="co">#&gt; -1.9737  -0.9216  -0.2155   0.5056   1.8969  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span>
<span class="co">#&gt; (Intercept)  3.22480    0.13669  23.592   &lt;2e-16 ***</span>
<span class="co">#&gt; logArea      0.34989    0.03543   9.877   &lt;2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  </span>
<span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; (Dispersion parameter for Negative Binomial(2.5333) family taken to be 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Null deviance: 130.161  on 29  degrees of freedom</span>
<span class="co">#&gt; Residual deviance:  32.604  on 28  degrees of freedom</span>
<span class="co">#&gt; AIC: 283.77</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of Fisher Scoring iterations: 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;               Theta:  2.533 </span>
<span class="co">#&gt;           Std. Err.:  0.719 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  2 x log-likelihood:  -277.772</span></code></pre></div>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ndata</span> <span class="op">=</span> <span class="va">gala</span> |&gt; <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html">expand</a></span><span class="op">(</span>logArea <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">logArea</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">logArea</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">21</span><span class="op">)</span><span class="op">)</span> 
<span class="va">ndata</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="va">ndata</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">H2_negbinom4</span>, newdata <span class="op">=</span> <span class="va">ndata</span>, type <span class="op">=</span> <span class="st">"link"</span>, se <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">ndata</span> <span class="op">=</span> <span class="va">ndata</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>expect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>,
         lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">fit</span> <span class="op">-</span> <span class="va">se.fit</span><span class="op">)</span>,
         upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">fit</span> <span class="op">+</span> <span class="va">se.fit</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gala</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">logArea</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ndata</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">expect</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ndata</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="24-analysis-glm_files/figure-html/unnamed-chunk-68-1.png" width="90%" style="display: block; margin: auto;"></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="anova.html"><span class="header-section-number">7</span> 分散分析</a></div>
<div class="next"><a href="gam.html"><span class="header-section-number">9</span> 一般化加法モデル</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#linear-models"><span class="header-section-number">8</span> 線形モデル</a></li>
<li><a class="nav-link" href="#%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8-7"><span class="header-section-number">8.1</span> 必要なパッケージ</a></li>
<li><a class="nav-link" href="#%E7%B7%9A%E5%BD%A2%E3%83%A2%E3%83%87%E3%83%AB%E3%81%A8%E3%81%AF"><span class="header-section-number">8.2</span> 線形モデルとは？</a></li>
<li><a class="nav-link" href="#%E7%B7%9A%E5%9E%8B%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AF%E7%9B%B4%E7%B7%9A%E3%81%98%E3%82%83%E3%81%AA%E3%81%8F%E3%81%A6%E3%82%82%E3%81%84%E3%81%84"><span class="header-section-number">8.3</span> 線型モデルは直線じゃなくてもいい</a></li>
<li><a class="nav-link" href="#%E7%B7%9A%E5%BD%A2%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BB%AE%E5%AE%9A"><span class="header-section-number">8.4</span> 線形モデルの仮定</a></li>
<li><a class="nav-link" href="#%E4%B8%80%E8%88%AC%E7%B7%9A%E5%BD%A2%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BE%8B-general-linear-model"><span class="header-section-number">8.5</span> 一般線形モデルの例 (General Linear Model)</a></li>
<li>
<a class="nav-link" href="#%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%BA%E6%96%AD"><span class="header-section-number">8.6</span> モデル診断</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E6%AE%8B%E6%B8%A3%E3%81%AE%E6%AD%A3%E8%A6%8F%E6%80%A7"><span class="header-section-number">8.6.1</span> 残渣の正規性</a></li>
<li><a class="nav-link" href="#%E6%AE%8B%E6%B8%A3%E3%81%AE%E3%81%B0%E3%82%89%E3%81%A4%E3%81%8D"><span class="header-section-number">8.6.2</span> 残渣のばらつき</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E3%82%AC%E3%83%A9%E3%83%91%E3%82%B4%E3%82%B9%E8%AB%B8%E5%B3%B6%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E7%A8%AE%E6%95%B0%E3%81%AE%E8%A7%A3%E6%9E%90"><span class="header-section-number">8.7</span> ガラパゴス諸島における種数の解析</a></li>
<li><a class="nav-link" href="#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E8%A8%BA%E6%96%AD%E5%9B%B3%E6%9C%9F%E5%BE%85%E5%80%A4%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E6%AE%8B%E5%B7%AE%E3%81%AE%E3%81%B0%E3%82%89%E3%81%A4%E3%81%8D"><span class="header-section-number">8.8</span> モデルの診断図：期待値に対する残差のばらつき</a></li>
<li>
<a class="nav-link" href="#%E3%83%A2%E3%83%87%E3%83%AB%E6%A7%8B%E7%AF%89%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9"><span class="header-section-number">8.9</span> モデル構築の考え方</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#%E5%BF%9C%E7%AD%94%E5%A4%89%E6%95%B0%E3%81%AE%E5%A4%89%E6%8F%9B"><span class="header-section-number">8.9.1</span> 応答変数の変換</a></li></ul>
</li>
<li>
<a class="nav-link" href="#%E5%BF%9C%E7%AD%94%E5%A4%89%E6%95%B0%E5%A4%89%E6%8F%9B%E3%81%97%E3%81%9F%E8%A7%A3%E6%9E%90"><span class="header-section-number">8.10</span> 応答変数変換した解析</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#%E5%BF%9C%E7%AD%94%E5%A4%89%E6%95%B0%E4%BB%A5%E5%A4%96%E3%81%AE%E8%A7%A3%E6%B1%BA%E6%89%8B%E6%B3%95"><span class="header-section-number">8.10.1</span> 応答変数以外の解決手法</a></li></ul>
</li>
<li><a class="nav-link" href="#%E5%8D%98%E7%B4%94%E5%8C%96%E3%81%97%E3%81%9F%E3%83%A2%E3%83%87%E3%83%AB"><span class="header-section-number">8.11</span> 単純化したモデル</a></li>
<li><a class="nav-link" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3"><span class="header-section-number">8.12</span> 診断図</a></li>
<li><a class="nav-link" href="#%E8%AA%AC%E6%98%8E%E5%A4%89%E6%95%B0%E3%82%82%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B"><span class="header-section-number">8.13</span> 説明変数も変換する</a></li>
<li><a class="nav-link" href="#%E4%B8%80%E8%88%AC%E5%8C%96%E7%B7%9A%E5%BD%A2%E3%83%A2%E3%83%87%E3%83%AB"><span class="header-section-number">8.14</span> 一般化線形モデル</a></li>
<li>
<a class="nav-link" href="#%E6%8C%87%E6%95%B0%E5%9E%8B%E5%88%86%E5%B8%83%E6%97%8F%E8%AA%A4%E5%B7%AE%E9%A0%85"><span class="header-section-number">8.15</span> 指数型分布族・誤差項</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E7%B7%9A%E5%BD%A2%E4%BA%88%E6%B8%AC%E5%AD%90%E3%81%BE%E3%81%9F%E3%81%AF%E7%B3%BB%E7%B5%B1%E6%88%90%E5%88%86"><span class="header-section-number">8.15.1</span> 線形予測子または系統成分</a></li>
<li><a class="nav-link" href="#%E9%80%A3%E7%B5%90%E9%96%A2%E6%95%B0-%E3%83%AA%E3%83%B3%E3%82%AF%E9%96%A2%E6%95%B0"><span class="header-section-number">8.15.2</span> 連結関数 (リンク関数)</a></li>
<li><a class="nav-link" href="#%E4%B8%80%E8%88%AC%E5%8C%96%E7%B7%9A%E5%BD%A2%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E6%8E%A8%E5%AE%9A%E6%96%B9%E6%B3%95"><span class="header-section-number">8.15.3</span> 一般化線形モデルの推定方法</a></li>
<li><a class="nav-link" href="#%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E8%AA%A4%E5%B7%AE%E9%A0%85"><span class="header-section-number">8.15.4</span> 一般的な誤差項</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E3%82%AC%E3%83%A9%E3%83%91%E3%82%B4%E3%82%B9%E8%AB%B8%E5%B3%B6%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AEglm%E8%A7%A3%E6%9E%90%E4%BE%8B"><span class="header-section-number">8.16</span> ガラパゴス諸島のデータのGLM解析例</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%9D%E3%82%A2%E3%82%BD%E3%83%B3glm%E8%A7%A3%E6%9E%90%E3%81%AE%E5%87%BA%E5%8A%9B"><span class="header-section-number">8.16.1</span> ポアソンGLM解析の出力</a></li>
<li><a class="nav-link" href="#%E5%AF%BE%E7%AB%8B%E3%83%A2%E3%83%87%E3%83%AB"><span class="header-section-number">8.16.2</span> 対立モデル</a></li>
<li><a class="nav-link" href="#%E5%AF%BE%E7%AB%8B%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E5%87%BA%E5%8A%9B"><span class="header-section-number">8.16.3</span> 対立モデルの出力</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E5%B0%A4%E5%BA%A6%E6%AF%94%E6%A4%9C%E5%AE%9A%E3%81%A8aic%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%A2%E3%83%87%E3%83%AB%E6%AF%94%E8%BC%83"><span class="header-section-number">8.17</span> 尤度比検定とAICにおけるモデル比較</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%9D%E3%82%A2%E3%82%BD%E3%83%B3%E5%88%86%E5%B8%83%E3%81%AE%E3%81%A8%E3%81%8D%E3%81%AB%E5%BF%85%E3%81%9A%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E5%80%A4"><span class="header-section-number">8.17.1</span> ポアソン分布のときに必ず確認する値</a></li>
<li><a class="nav-link" href="#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E6%94%B9%E8%89%AF"><span class="header-section-number">8.17.2</span> モデルの改良</a></li>
<li><a class="nav-link" href="#%E9%81%8E%E5%88%86%E6%95%A3%E3%82%92%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%81%A8%E3%81%97%E3%81%A6%E6%89%B1%E3%81%86"><span class="header-section-number">8.17.3</span> 過分散をパラメータとして扱う</a></li>
<li><a class="nav-link" href="#%E8%B2%A0%E3%81%AE%E4%BA%8C%E9%A0%85%E5%88%86%E5%B8%83glm%E3%81%AE%E8%A8%BA%E6%96%AD%E5%9B%B3"><span class="header-section-number">8.17.4</span> 負の二項分布GLMの診断図</a></li>
<li><a class="nav-link" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E6%AE%8B%E5%B7%AE%E3%81%AE%E3%83%92%E3%82%B9%E3%83%88%E3%82%B0%E3%83%A9%E3%83%A0"><span class="header-section-number">8.17.5</span> 診断図関数：残差のヒストグラム</a></li>
<li><a class="nav-link" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E6%AE%8B%E5%B7%AE%E3%81%AEqq%E3%83%97%E3%83%AD%E3%83%83%E3%83%88"><span class="header-section-number">8.17.6</span> 診断図関数：残差のQQプロット</a></li>
<li><a class="nav-link" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E5%A4%89%E6%95%B0%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E6%AE%8B%E5%B7%AE%E3%81%AE%E3%81%B0%E3%82%89%E3%81%A4%E3%81%8D"><span class="header-section-number">8.17.7</span> 診断図関数：変数に対する残差のばらつき</a></li>
<li><a class="nav-link" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E6%9C%9F%E5%BE%85%E5%80%A4%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E6%AE%8B%E5%B7%AE%E3%81%AE%E3%81%B0%E3%82%89%E3%81%A4%E3%81%8D"><span class="header-section-number">8.17.8</span> 診断図関数：期待値に対する残差のばらつき</a></li>
<li><a class="nav-link" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%AB%E3%83%AD%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%97%E3%83%AD%E3%83%83%E3%83%88"><span class="header-section-number">8.17.9</span> 診断図関数：スケール・ロケーションプロット</a></li>
<li><a class="nav-link" href="#%E8%A8%BA%E6%96%AD%E5%9B%B3%E9%96%A2%E6%95%B0%E3%82%AF%E3%83%83%E3%82%AF%E3%81%AE%E8%B7%9D%E9%9B%A2"><span class="header-section-number">8.17.10</span> 診断図関数：クックの距離</a></li>
<li><a class="nav-link" href="#%CE%B7-%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%83%A9%E3%83%B3%E3%83%80%E3%83%A0%E5%8C%96%E6%AE%8B%E5%B7%AE%E3%81%AE%E3%81%B0%E3%82%89%E3%81%A4%E3%81%8D"><span class="header-section-number">8.17.11</span> η に対するランダム化残差のばらつき</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E7%B5%90%E6%9E%9C"><span class="header-section-number">8.18</span> 結果</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E8%B2%A0%E3%81%AE%E4%BA%8C%E9%A0%85%E5%88%86%E5%B8%83%E3%81%AE%E7%B5%90%E6%9E%9C%E4%BF%82%E6%95%B0%E8%A1%A8"><span class="header-section-number">8.18.1</span> 負の二項分布の結果（係数表）</a></li>
<li><a class="nav-link" href="#aic"><span class="header-section-number">8.18.2</span> AIC</a></li>
<li><a class="nav-link" href="#%E5%B0%A4%E5%BA%A6%E6%AF%94%E6%A4%9C%E5%AE%9A"><span class="header-section-number">8.18.3</span> 尤度比検定</a></li>
<li><a class="nav-link" href="#%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%BA%E6%96%AD%E5%9B%B3"><span class="header-section-number">8.18.4</span> モデル診断図</a></li>
<li><a class="nav-link" href="#%E6%8E%A1%E6%8A%9E%E3%81%97%E3%81%9F%E3%83%A2%E3%83%87%E3%83%AB"><span class="header-section-number">8.18.5</span> 採択したモデル</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/gnishihara/Lab-Manual/blob/master/24-analysis-glm.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/gnishihara/Lab-Manual/edit/master/24-analysis-glm.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>データ解析マニュアル</strong>" was written by 水圏植物生態学研究室 (greg nishihara). It was last built on 2022-05-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
